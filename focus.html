<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <title>Focus Flight - Navigation Immersive</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        :root { 
            --accent: #1778bdcf;
            --bg-color: #c8dff6;
            --text-color: #1a2a6c;
            --glass: rgba(255, 255, 255, 0.7);
            --line-color: #1a2a6c;
        }

        [data-theme="mixed"] {
            --accent: #70bbf1d4;
            --bg-color: #0b132b;
            --text-color: #ffffff;
            --glass: rgba(255, 255, 255, 0.1);
            --line-color: #1a2a6c;
        }

        [data-theme="dark"] {
            --accent: #ff9f43; 
            --bg-color: #0b132b;
            --text-color: #ffffff;
            --glass: rgba(255, 255, 255, 0.1);
            --line-color: #ffffff;
        }

        body {
            margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            transition: background 0.5s ease; /* Animation fluide */
            display: flex; justify-content: center; align-items: center;
            height: 100vh; overflow: hidden;
        }
        
        /* -- BOUTON DE CHOIX DU THEME -- */
        #theme-switcher {
            position: fixed; top: 20px; right: 20px;
            z-index: 1000; background: var(--glass);
            border: 1px solid rgba(255,255,255,0.2);
            padding: 10px; border-radius: 12px;
            cursor: pointer; color: var(--text-color);
            backdrop-filter: blur(10px);
        }
        #menu-toggle {
            position: fixed; top: 20px; left: 20px;
            z-index: 1000; background: var(--glass);
            border: 1px solid rgba(255,255,255,0.2);
            padding: 10px 15px; border-radius: 12px;
            cursor: pointer; font-size: 1.2rem;
            backdrop-filter: blur(10px); color: var(--text-color);
        }

        #audio-settings {
            position: fixed; top: 80px; left: 20px;
            width: 250px; z-index: 1001;
            padding: 20px; text-align: left;
        }

        .setting-item {
            display: flex; justify-content: space-between;
            align-items: center; margin: 15px 0;
        }

        input[type="range"] { cursor: pointer; accent-color: var(--accent); }

        #audio-settings select {
            width: 120px;
            padding: 5px;
            font-size: 0.8rem;
            background: rgba(255,255,255,0.1);
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
        }
        #audio-settings option {
            background: #0b132b; /* Fond sombre pour les options sur mobile */
        }

        #strict-toggle-btn {
            position: fixed;
            top: 80px; /* Juste sous le bouton menu qui est √† 20px + sa hauteur */
            left: 20px;
            z-index: 1000;
            width: 45px;
            height: 45px;
            border-radius: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
            cursor: pointer;
            background: var(--glass);
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            color: var(--text-color);
            transition: all 0.3s ease;
        }

        /* Style quand le mode est activ√© (bouton plus "lumineux") */
        #strict-toggle-btn.active {
            background: rgba(255, 159, 67, 0.3); /* Teinte orange accent */
            border-color: var(--accent);
            box-shadow: 0 0 15px rgba(255, 159, 67, 0.4);
        }

        /* --- STYLE GLASSMORPHISM (√âcran Accueil) --- */
        .glass-card {
            background: var(--glass);
            backdrop-filter: blur(15px);
            padding: 40px; border-radius: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
            z-index: 10;
        }

        h1 { margin-top: 0; font-weight: 300; letter-spacing: 2px; }

        select {
            padding: 12px; border-radius: 10px; margin: 10px;
            background: rgba(255,255,255,0.9); border: none;
            font-size: 1rem; color: #0b132b;
        }

        /* Style pour la s√©lection par dur√©e */
        .duration-picker {
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .roulette-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
        }

        .roulette-container select {
            width: 70px;
            text-align: center;
            font-weight: bold;
            cursor: pointer;
        }

        .btn-random {
            background: transparent;
            color: var(--accent);
            border: 2px solid var(--accent);
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.3s;
        }

        .btn-random:hover {
            background: var(--accent);
            color: white;
        }

        /* --- BOUTON D√âCOLLAGE --- */
        .btn-takeoff {
            position: fixed; bottom: 40px; right: 40px;
            padding: 20px 45px; background: var(--accent);
            border: none; border-radius: 50px; color: white;
            font-size: 1.2rem; font-weight: bold; cursor: pointer;
            box-shadow: 0 10px 20px var(--accent);
            transition: all 0.3s ease;
            z-index: 100;
        }
        .btn-takeoff:hover { transform: scale(1.05); background: var(--accent); filter: brightness(1.15); }

        /* --- √âCRAN DE VOL --- */
        #flight-screen {
            display: none; flex-direction: column; align-items: center;
            width: 100%; height: 100%; justify-content: center;
        }

        .timer-large {
            font-size: 5vw; font-weight: bold; margin-bottom: 10px;
            text-shadow: 0 4px 10px rgba(0,0,0,0.5);
            font-variant-numeric: tabular-nums; /* Optionnel : emp√™che les chiffres de "sauter" */
        }
        
        .progress-container {
            width: 60%; height: 8px; background: rgba(255,255,255,0.1);
            border-radius: 10px; margin-bottom: 30px; overflow: hidden;
        }
        #progress-bar { width: 0%; height: 100%; background: var(--accent); }

        #map {
            width: 70%; height: 45vh; border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .hidden { display: none !important; }
        
        /* Style de l'ic√¥ne avion sur la carte */
        .plane-icon {font-size: 24px; text-align: center; line-height: 24px; transition: all 1s linear; } /* L'avion met 1 seconde pour glisser vers sa nouvelle position */
        
        /* Bouton de retour √† la fin du vol */
        .btn-return {
            margin-top: 20px;
            padding: 12px 25px;
            background: var(--glass);
            color: var(--text-color);
            border: 1px solid rgba(128,128,128,0.5);
            border-radius: 15px;
            cursor: pointer;
            font-weight: bold;
            backdrop-filter: blur(5px);
            transition: 0.3s;
        }
        .btn-return:hover {
            background: var(--accent);
            color: white;
        }
        @media (max-width: 600px) {
            .timer-large { font-size: 15vw; } /* Plus gros sur mobile */
            .glass-card { width: 90%; padding: 20px; }
            .btn-takeoff { bottom: 20px; right: 20px; padding: 15px 30px; }
        }
    </style>
</head>
<body>
    <button id="menu-toggle" onclick="toggleMenu()">‚öôÔ∏è</button>

    <button id="strict-toggle-btn" class="glass-btn" onclick="toggleStrictVisual()" title="Mode Strict">üîì</button>
    <input type="checkbox" id="strict-mode" class="hidden">

    <div id="audio-settings" class="glass-card hidden">
        <h3>R√©glages Sonores</h3>
        <div class="setting-item">
            <label>Ambiance Cabine</label>
            <input type="checkbox" id="ambient-toggle" onchange="updateAmbient()">
        </div>
        <div class="setting-item">
            <label>Type de son</label>
            <select id="ambient-type" onchange="changeAmbientType()">
                <option value="ambiance1.mp3">Cabine Standard</option>
                <option value="ambiance2.mp3">Cabine B737</option>
                <option value="cessna.mp3">Cabine Cessna</option>
                <option value="atmos.mp3">Cabine vol atmosph√©rique</option>
            </select>
        </div>
        <div class="setting-item">
            <label>Volume</label>
            <input type="range" id="volume-slider" min="0" max="1" step="0.1" value="0.5" oninput="updateAmbient()">
        </div>
        <button class="btn-random" onclick="toggleMenu()">Fermer</button>
    </div>

    <button id="theme-switcher" onclick="toggleTheme()">üåì Changer de vue</button>

    <div id="selection-screen" class="glass-card">
        <h1>‚úàÔ∏è FOCUS FLIGHT</h1>
        <p>Configurez votre voyage de concentration</p>
        <div>
            <select id="origin"></select>
            <span> vers </span>
            <select id="destination"></select>
        </div>
        <div class="duration-picker">
            <p>Ou d√©finissez un temps de focus :</p>
            <div class="roulette-container">
                <select id="pick-hours"></select> H : 
                <select id="pick-mins"></select> M
            </div>
            <button class="btn-random" onclick="proposeRandomFlight()">üé≤ Proposer un trajet al√©atoire</button>
        </div>
        <p id="estimated-time" style="color: var(--accent); font-weight: bold; margin-top: 20px;">Dur√©e : -- min</p>
    </div>

    <button class="btn-takeoff" id="btn-go" onclick="takeOff()">D√âCOLLAGE</button>

    <div id="flight-screen">
        <div id="flight-info" style="letter-spacing: 3px; margin-bottom: 10px; opacity: 0.8;">VOL EN COURS VERS <span id="dest-name">...</span></div>
        <div class="timer-large" id="timerDisplay">00:00</div>
        <div class="progress-container"><div id="progress-bar"></div></div>
        <div id="map"></div>
        <button id="btn-home" class="btn-return hidden" onclick="resetToHome()">üè† Retour au terminal</button>
    </div>

    <div id="arrival-modal" class="glass-card hidden" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 2000; width: 300px;">
        <h2 style="color: var(--accent);">üõ¨ BIENVENUE !</h2>
        <p>Votre session de focus est termin√©e avec succ√®s.</p>
        <button class="btn-takeoff" style="position: static; margin-top: 20px;" onclick="closeArrivalModal()">OK</button>
    </div>

    <div id="modal-overlay" class="hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(5px); z-index: 1999;"></div>

    <script>
        let currentTheme = 'dark'; // √âtat initial
        let tileLayer; // On cr√©e une variable pour stocker la couche de la carte
        let flightEndTime; // Stockera le timestamp (en millisecondes) de l'atterrissage
        let isAutoCenterEnabled = true; // L'interrupteur
        let autoCenterTimeout; // Le compte √† rebours avant r√©activation
        let dingTimers = []; // Tableau pour stocker les chronom√®tres des dings

        // Sons : modifier les fichiers mp3 dans HTML pour ajouter des sons
        const ambientSound = new Audio('ambiance.mp3');
        ambientSound.loop = true;

        // On d√©finit la source par d√©faut tout de suite pour √©viter le "vide"
        ambientSound.src = document.getElementById('ambient-type')?.value || 'ambiance.mp3';

        const dingSound = new Audio('ding.mp3'); // Un "ding" clair

        function toggleMenu() {
            document.getElementById('audio-settings').classList.toggle('hidden');
            // On profite de l'ouverture du menu pour "pr√©-charger" les sons
            // On ne fait LOAD que si le son est en pause (au tout d√©but) pour √©viter de couper le son en plein vol
            if (ambientSound.paused) {
                ambientSound.load();
                dingSound.load();
            }
        }

        function changeAmbientType() {
            const selectedFile = document.getElementById('ambient-type').value;
    
            // On m√©morise si le son √©tait en train de jouer
            const wasPlaying = !ambientSound.paused;
    
            // On change la source
            ambientSound.src = selectedFile;
            ambientSound.load(); // FORCE le navigateur √† pr√©parer le fichier
    
            // Si le son tournait, on relance le nouveau fichier imm√©diatement
            if (wasPlaying) {
                ambientSound.play().catch(e => console.warn("Attente d'interaction"));
            }
        }

        function updateAmbient() {
            const isActive = document.getElementById('ambient-toggle').checked;
            const volume = document.getElementById('volume-slider').value;
            const isFlying = document.getElementById('flight-screen').style.display === 'flex';
    
            ambientSound.volume = volume;
    
            if (isActive && isFlying) {
                // Le secret : on appelle load() si le son est √† l'arr√™t pour le "r√©veiller"
                if (ambientSound.paused) {
                    ambientSound.load(); 
                    // On utilise un petit d√©lai pour laisser le temps au chargement
                    ambientSound.play()
                        .then(() => console.log("Audio d√©marr√© !"))
                        .catch(e => {
                            console.log("Le navigateur bloque encore. On r√©essaiera au prochain clic.");
                        });
                }
            } else {
                ambientSound.pause();
            }
        }

        function toggleTheme() {
            const themes = ['dark', 'light', 'mixed'];
            // On passe au th√®me suivant dans le tableau
            currentTheme = themes[(themes.indexOf(currentTheme) + 1) % themes.length];
    
            // On applique l'attribut au HTML pour que le CSS change
            document.documentElement.setAttribute('data-theme', currentTheme);
    
            // Si la carte existe d√©j√†, on met √† jour son style
            if (map) {
                updateMapStyle();
            }
        }

        function toggleStrictVisual() {
            const btn = document.getElementById('strict-toggle-btn');
            const checkbox = document.getElementById('strict-mode');
    
            checkbox.checked = !checkbox.checked; // Inverse l'√©tat

            if (checkbox.checked) {
                btn.classList.add('active');
                btn.innerHTML = "üîí";
                // SI ON EST EN VOL : On verrouille imm√©diatement !
                const isFlying = document.getElementById('flight-screen').style.display === 'flex';
                if (isFlying) {
                    document.getElementById('menu-toggle').classList.add('hidden');
                    document.getElementById('theme-switcher').classList.add('hidden');
                        // Optionnel : cacher le bouton de verrouillage lui-m√™me maintenant qu'il est ferm√©
                    btn.classList.add('hidden'); 
                }
            } else {
                btn.classList.remove('active');
                btn.innerHTML = "üîì";
            }
        }

        function updateMapStyle() {
            // Si une couche de carte existe, on l'enl√®ve pour mettre la nouvelle
            if (tileLayer) map.removeLayer(tileLayer);
    
            let url;
            // Mode Dark -> Carte sombre. Modes Light et Mixed -> Carte claire.
            if (currentTheme === 'dark') {
                url = 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png';
            } else {
                url = 'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png';
            }
    
            tileLayer = L.tileLayer(url).addTo(map);

            // On r√©cup√®re la couleur de ligne d√©finie dans le CSS (variable --line-color)
            const color = getComputedStyle(document.documentElement).getPropertyValue('--line-color').trim();
            if (flightLine) {
                flightLine.setStyle({ color: color });
            }
        }
        // Remplir la roulette des heures
        const hSelect = document.getElementById('pick-hours');
        for(let i=0; i<24; i++) {
            hSelect.innerHTML += `<option value="${i}">${i.toString().padStart(2, '0')}</option>`;
        }

        // Remplir la roulette des minutes (par pas de 5 pour plus de simplicit√©)
        const mSelect = document.getElementById('pick-mins');
        for(let i=0; i<60; i+=5) {
            mSelect.innerHTML += `<option value="${i}">${i.toString().padStart(2, '0')}</option>`;
        }

        function formatTimeHHMMSS(totalSeconds) {
            const h = Math.floor(totalSeconds / 3600);
            const m = Math.floor((totalSeconds % 3600) / 60);
            const s = totalSeconds % 60;

            // On utilise padStart pour forcer 2 chiffres (01:05:08 au lieu de 1:5:8)
            const hours = h.toString().padStart(2, '0');
            const minutes = m.toString().padStart(2, '0');
            const seconds = s.toString().padStart(2, '0');

            return `${hours}:${minutes}:${seconds}`;
        }

        const airports = [
            // --- BELGIQUE & FRANCE ---
            { id: "BRU", name: "Bruxelles-National", lat: 50.9014, lon: 4.4844 },
            { id: "CRL", name: "Charleroi (Sud)", lat: 50.4592, lon: 4.4538 },
            { id: "CDG", name: "Paris Charles de Gaulle", lat: 49.0097, lon: 2.5479 },
            { id: "NCE", name: "Nice C√¥te d'Azur", lat: 43.6653, lon: 7.2150 },
            { id: "LBG", name: "Paris - Le Bourget LBG", lat: 48.9694, lon: 2.4414 },
            
            // --- TEST ---
            { id: "TST", name: "Test a√©roport fant√¥me", lat: 50.9500, lon: 4.4844 },

            // --- EUROPE --- 
            { id: "LHR", name: "Londres Heathrow", lat: 51.4700, lon: -0.4543 },
            { id: "MAD", name: "Madrid Barajas", lat: 40.4839, lon: -3.5680 },
            { id: "BER", name: "Berlin Brandenburg", lat: 52.3667, lon: 13.5033 },
            { id: "FCO", name: "Rome Fiumicino", lat: 41.8003, lon: 12.2389 },
            { id: "AMS", name: "Amsterdam Schiphol", lat: 52.3105, lon: 4.7683 },
            { id: "LIS", name: "Lisbonne Humberto Delgado", lat: 38.7742, lon: -9.1342 },
            { id: "ATH", name: "Ath√®nes Elefth√©rios-Veniz√©los", lat: 37.9364, lon: 23.9445 },
            { id: "GVA", name: "Gen√®ve A√©roport", lat: 46.2370, lon: 6.1091 },
            { id: "DUB", name: "Dublin Airport", lat: 53.4264, lon: -6.2499 },
            { id: "OSL", name: "Oslo Gardermoen", lat: 60.1976, lon: 11.1004 },

            // --- INTERNATIONAL (Long-courriers) ---
            { id: "JFK", name: "New York JFK", lat: 40.6413, lon: -73.7781 },
            { id: "DXB", name: "Duba√Ø International", lat: 25.2532, lon: 55.3657 },
            { id: "HND", name: "Tokyo Haneda", lat: 35.5494, lon: 139.7798 },
            { id: "SIN", name: "Singapour Changi", lat: 1.3644, lon: 103.9915 },
            { id: "LAX", name: "Los Angeles Intl", lat: 33.9416, lon: -118.4085 },
            { id: "SYD", name: "Sydney Kingsford Smith", lat: -33.9399, lon: 151.1753 }
        ];

        let map, planeMarker, flightLine;
        let timeLeft, totalTime, timerInterval;
        let startCoords, endCoords;

        const originSelect = document.getElementById('origin');
        const destSelect = document.getElementById('destination');

        airports.forEach(ap => {
            originSelect.innerHTML += `<option value="${ap.id}">${ap.name}</option>`;
            destSelect.innerHTML += `<option value="${ap.id}">${ap.name}</option>`;
        });

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function updateDurationDisplay() {
            const a = airports.find(x => x.id === originSelect.value);
            const b = airports.find(x => x.id === destSelect.value);
            if(a.id === b.id) {
                document.getElementById('estimated-time').textContent = "Choisissez une destination diff√©rente";
                return;
            }
            const dist = calculateDistance(a.lat, a.lon, b.lat, b.lon);

            // Buffer de 2 min minimum si vol de <25km et 15 min si vol >25km
            const buffer = dist < 25 ? 2 : 15; 
            const totalMinutes = Math.max(1, Math.round((dist / 800) * 60 + buffer));

            // On convertit les minutes en secondes pour notre fonction de formatage
            const timeString = formatTimeHHMMSS(totalMinutes * 60);
            document.getElementById('estimated-time').textContent = `Dur√©e estim√©e : ${timeString}`;
        }

        [originSelect, destSelect].forEach(s => s.addEventListener('change', updateDurationDisplay));
        updateDurationDisplay();

        function proposeRandomFlight() {
            const targetHours = parseInt(document.getElementById('pick-hours').value);
            const targetMins = parseInt(document.getElementById('pick-mins').value);
            const targetTotalMins = (targetHours * 60) + targetMins;

            if (targetTotalMins === 0) return alert("Choisissez une dur√©e sup√©rieure √† 0 !");

            let validFlights = [];

            // On parcourt tous les a√©roports de d√©part possibles
            for (let i = 0; i < airports.length; i++) {
                // On parcourt tous les a√©roports d'arriv√©e possibles
                for (let j = 0; j < airports.length; j++) {
                    if (i === j) continue; // Pas de vol vers la m√™me ville

                    const start = airports[i];
                    const end = airports[j];
            
                    // On calcule la dur√©e de ce trajet
                    const dist = calculateDistance(start.lat, start.lon, end.lat, end.lon);
                    const flightMins = Math.round((dist / 800) * 60 + 20);

                    // On v√©rifie si √ßa correspond √† la dur√©e demand√©e (marge de +/- 15 min)
                    if (Math.abs(flightMins - targetTotalMins) <= 15) {
                        validFlights.push({ start: start.id, end: end.id });
                    }
                }
            }

            if (validFlights.length > 0) {
                // --- LE POINT AL√âATOIRE ---
                // On choisit un trajet au hasard parmi ceux qui correspondent
                const randomChoice = validFlights[Math.floor(Math.random() * validFlights.length)];
        
                // On met √† jour les s√©lecteurs de la page d'accueil
                document.getElementById('origin').value = randomChoice.start;
                document.getElementById('destination').value = randomChoice.end;
        
                // On met √† jour l'affichage du temps
                updateDurationDisplay();
                
                // Petit effet visuel pour montrer que √ßa a chang√©
                document.getElementById('selection-screen').style.boxShadow = "0 0 20px var(--accent)";
                setTimeout(() => {
                    document.getElementById('selection-screen').style.boxShadow = "0 8px 32px rgba(0,0,0,0.5)";
                }, 500);

            }else {
                alert("Aucun vol trouv√© pour cette dur√©e. Essayez un autre temps !");
            }
        }

        function takeOff() {
            const a = airports.find(x => x.id === originSelect.value);
            const b = airports.find(x => x.id === destSelect.value);
            if (a.id === b.id) return;

            startCoords = [a.lat, a.lon];
            endCoords = [b.lat, b.lon];
            const dist = calculateDistance(a.lat, a.lon, b.lat, b.lon);

            // Buffer de 2 min minimum si vol de <50km et 15 min si vol >50km
            const buffer = dist < 50 ? 2 : 15; 
            const totalMinutes = Math.max(1, Math.round((dist / 800) * 60 + buffer));
            totalTime = totalMinutes * 60;
            timeLeft = totalTime;
    
            // Date.now() donne l'heure actuelle en millisecondes. 
            // On y ajoute la dur√©e du vol convertie en millisecondes.
            flightEndTime = Date.now() + (totalTime * 1000);

            // --- GESTION DU MODE STRICT ---
            const isStrictMode = document.getElementById('strict-mode').checked;
            if (isStrictMode) {
                // On cache les boutons de r√©glages et de th√®me
                document.getElementById('menu-toggle').classList.add('hidden');
                document.getElementById('theme-switcher').classList.add('hidden');
                // On cache le bouton de mode strict d√®s qu'on d√©colle si le mode strict est actif
                document.getElementById('strict-toggle-btn').classList.add('hidden');
            }

            // 1. Afficher d'abord l'√©cran de vol (tr√®s important pour que les √©l√©ments soient visibles)
            document.getElementById('selection-screen').classList.add('hidden');
            document.getElementById('btn-go').classList.add('hidden');
            document.getElementById('flight-screen').style.display = 'flex';
            
            // 2. On change le texte de l'info-vol sans √©craser le HTML
            // On s'assure que l'√©l√©ment existe avant d'√©crire dedans
            const destNameElement = document.getElementById('dest-name');
            if (destNameElement) {
                destNameElement.textContent = b.name.toUpperCase();
            }

            // 3. R√©initialiser le reste de l'UI
            document.getElementById('progress-bar').style.width = "0%";
            document.getElementById('timerDisplay').textContent = formatTimeHHMMSS(totalTime);

            initMap();
            startTimer();
            updateAmbient();
        }

        function initMap() {
            // On cr√©e la carte UNE SEULE FOIS avec toutes les options (PC + Mobile)
            map = L.map('map', { 
                zoomControl: false,
                dragging: !L.Browser.mobile, // Optimisation mobile
                tap: false 
            }).setView(startCoords, 5);

            // Quand l'utilisateur commence √† bouger la carte
            map.on('movestart', () => {
                isAutoCenterEnabled = false; // On coupe le centrage auto
                clearTimeout(autoCenterTimeout); // On annule le timer de r√©activation s'il tournait
            });

            // Quand l'utilisateur arr√™te de bouger la carte
            map.on('moveend', () => {
                // On attend 3 secondes avant de r√©activer le centrage automatique
                autoCenterTimeout = setTimeout(() => {
                    isAutoCenterEnabled = true;
                }, 1500); // Tu peux changer 1500 (1.5s) par le d√©lai de ton choix
            });

            // On applique le style (Sombre/Clair)
            updateMapStyle();
    
            // On r√©cup√®re la couleur pour la ligne
            const color = getComputedStyle(document.documentElement).getPropertyValue('--line-color').trim();
    
            // On dessine la ligne de trajectoire
            flightLine = L.polyline([startCoords, endCoords], {
                color: color, 
                weight: 2, 
                dashArray: '10, 10'
            }).addTo(map);
    
            // On ajoute l'ic√¥ne de l'avion
            const planeIcon = L.divIcon({ html: '‚úàÔ∏è', className: 'plane-icon', iconAnchor: [12, 12] });
            planeMarker = L.marker(startCoords, {icon: planeIcon}).addTo(map);
        }

        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);

            timerInterval = setInterval(() => {
                // Calcul du temps restant r√©el : (Heure de fin - Heure actuelle) / 1000
                const now = Date.now();
                const difference = Math.floor((flightEndTime - now) / 1000);

                if (difference > 0) {
                    timeLeft = difference;
                    updateUI();
                } else {
                    // Le vol est termin√©
                    timeLeft = 0;
                    updateUI();
                    clearInterval(timerInterval);
                    timerInterval = null;
                    ambientSound.pause(); // On arr√™te le moteur √† l'arriv√©e
                    
                    // 2. S√©quence de Dings
                    const playDing = () => {
                        dingSound.currentTime = 0;
                        dingSound.play().catch(e => console.log("Erreur son"));
                    };

                    // On vide le tableau avant de commencer
                    dingTimers = [];
                    // On stocke les timers pour pouvoir les annuler si besoin
                    playDing(); // Imm√©diat
                    dingTimers.push(setTimeout(playDing, 5000)); // 2e ding apr√®s 5s
                    dingTimers.push(setTimeout(playDing, 10000)); // 2e ding apr√®s 10s

                    // 3. Affichage de la fen√™tre personnalis√©e au lieu de l'alert()
                    document.getElementById('arrival-modal').classList.remove('hidden');
                    document.getElementById('modal-overlay').classList.remove('hidden');
                    
                    // 4. Mise √† jour de l'interface (force l'affighage √† 00:00, affiche le bouton de retour, affiche un petit message de f√©licitations)
                    document.getElementById('timerDisplay').textContent = "00:00";
                    document.getElementById('btn-home').classList.remove('hidden');
                    document.getElementById('menu-toggle').classList.remove('hidden');
                    document.getElementById('theme-switcher').classList.remove('hidden');
                    document.getElementById('flight-info').textContent = "BIENVENUE √Ä DESTINATION !";
                }
            }, 1000);
        }

        function updateUI() {
            // PLUS BESOIN de calculer les mins et secs ici, on utilise notre fonction formatTime!
            document.getElementById('timerDisplay').textContent = formatTimeHHMMSS(timeLeft);
    
            const progress = (totalTime - timeLeft) / totalTime;
            document.getElementById('progress-bar').style.width = (progress * 100) + "%";

            // Calcul position actuelle
            const currentLat = startCoords[0] + (endCoords[0] - startCoords[0]) * progress;
            const currentLon = startCoords[1] + (endCoords[1] - startCoords[1]) * progress;
            const newPos = [currentLat, currentLon];

            // 1. L'avion avance TOUJOURS
            planeMarker.setLatLng(newPos);
    
            // 2. La carte ne se centre QUE SI l'utilisateur ne la touche pas
            if (isAutoCenterEnabled) {
                // panTo avec animation pour plus de fluidit√©
                map.panTo(newPos, { animate: true, duration: 0.5 });
            }
        }

        function resetToHome() {
            // Arr√™ter proprement le timer s'il tourne encore
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            // R√©initialisation des variables de temps
            timeLeft = 0;
            totalTime = 0;
            flightEndTime = 0;
            // 1. On cache l'√©cran de vol et le bouton de retour
            document.getElementById('flight-screen').style.display = 'none';
            document.getElementById('btn-home').classList.add('hidden');

            document.getElementById('arrival-modal').classList.add('hidden');
            document.getElementById('modal-overlay').classList.add('hidden');

            // 2. On r√©affiche l'accueil et le bouton d√©collage
            document.getElementById('selection-screen').classList.remove('hidden');
            document.getElementById('btn-go').classList.remove('hidden');

            // 3. On d√©truit la carte pour pouvoir la recr√©er proprement au prochain vol
            // (C'est comme lib√©rer la m√©moire en C avec free() !)
            if (map) {
                map.off(); // Supprime tous les √©couteurs d'√©v√©nements
                map.remove();
                map = null;
            }
        }

        // Cette fonction ferme la fen√™tre d'arriv√©e √† destination quand on clique sur OK
        function closeArrivalModal() {
            // 1. On annule les dings qui n'ont pas encore sonn√©
            dingTimers.forEach(timer => clearTimeout(timer));
            dingTimers = []; // On vide le tableau

            // 2. On coupe le son imm√©diatement s'il est en train de jouer
            dingSound.pause();
            dingSound.currentTime = 0;

            // 3. On cache la fen√™tre
            document.getElementById('arrival-modal').classList.add('hidden');
            document.getElementById('modal-overlay').classList.add('hidden');
        }

        // Cette fonction "d√©bloque" l'audio sur les navigateurs capricieux
        document.body.addEventListener('click', function() {
            if (ambientSound.paused && document.getElementById('ambient-toggle').checked) {
                ambientSound.play().catch(() => {}); 
            }
        }, { once: true }); // Ne s'ex√©cute qu'une seule fois

        window.onbeforeunload = function() {
            // Si un vol est en cours (timerInterval existe), on demande confirmation
            if (timerInterval) {
                return "Votre vol est en cours ! Si vous quittez, votre session de focus sera perdue.";
            }
        };

    </script>
</body>
</html>