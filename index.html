<!DOCTYPE html>
<html lang="fr">
<head>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <title>Focus Flight - Navigation Immersive</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        :root { 
            --accent: #1778bdcf;
            --bg-color: #c8dff6;
            --text-color: #1a2a6c;
            --glass: rgba(255, 255, 255, 0.1);
            --line-color: #1a2a6c;
        }

        [data-theme="mixed"] {
            --accent: #70bbf1d4;
            --bg-color: #0b132b;
            --text-color: #ffffff;
            --glass: rgba(255, 255, 255, 0.1);
            --line-color: #1a2a6c;
        }

        [data-theme="dark"] {
            --accent: #ff9f43; 
            --bg-color: #0b132b;
            --text-color: #ffffff;
            --glass: rgba(255, 255, 255, 0.1);
            --line-color: #ffffff;
        }

        body {
            margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            transition: background 0.5s ease; /* Animation fluide */
            display: flex; justify-content: center; align-items: center;
            height: 100vh; overflow: hidden;
        }
        
        /* -- BOUTON DE CHOIX DU THEME -- */
        #theme-switcher {
            position: fixed; top: 20px; right: 20px;
            z-index: 1000; background: var(--glass);
            border: 1px solid rgba(255,255,255,0.2);
            padding: 10px; border-radius: 12px;
            cursor: pointer; color: var(--text-color);
            backdrop-filter: blur(10px);
        }
        #menu-toggle {
            position: fixed; top: 20px; left: 20px;
            z-index: 1000; background: var(--glass);
            border: 1px solid rgba(255,255,255,0.2);
            padding: 10px 15px; border-radius: 12px;
            cursor: pointer; font-size: 1.2rem;
            backdrop-filter: blur(10px); color: var(--text-color);
        }

        #settings-panel {
            position: fixed; top: 140px; left: 20px;
            width: 250px; max-width: 100vw; z-index: 1001;
            text-align: left;
            display: flex; flex-direction: column;
            padding: 20px; box-sizing: border-box; /* Important pour que le padding n'√©largisse pas le menu */
        }

        .setting-item {
            display: flex; justify-content: space-between;
            align-items: center; margin: 15px 0;
        }

        input[type="range"] { cursor: pointer; accent-color: var(--accent); }

        #settings-panel select {
            width: 120px;
            padding: 5px;
            font-size: 0.8rem;
            background: rgba(255,255,255,0.1);
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
        }
        #settings-panel option {
            background: #0b132b; /* Fond sombre pour les options sur mobile */
        }

        .glass-btn-small {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(5px);
            color: var(--text-color);
            padding: 5px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.2s ease;
        }

        .glass-btn-small:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 15px 0;
            width: 100%;
        }

        /* Style du bouton dans le menu */
        .menu-btn-history {
            background: var(--glass);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-color);
            padding: 10px 15px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .menu-btn-history:hover {
            background: var(--accent);
            color: white;
            transform: translateY(-2px);
        }

        /* La Modal qui survole tout */
        #history-modal {
            position: fixed; /* Fix√© par dessus tout */
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(var(--bg-color), 0.6); /* Overlay adapt√© au th√®me et glass */
            display: none; /* Pilot√© par JS */
            justify-content: center;
            align-items: center;
            z-index: 10000; /* Priorit√© absolue */
            backdrop-filter: blur(5px);
        }

        .history-content-glass {
            background: var(--glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text-color);
            padding: 30px;
            border-radius: 24px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
            animation: modalAppear 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28);
        }

        @keyframes modalAppear {
            from { opacity: 0; transform: scale(0.9) translateY(20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        /* Scrollbar personnalis√©e pour le glassomorphisme */
        #history-list-box::-webkit-scrollbar {
            width: 6px;
        }
        #history-list-box::-webkit-scrollbar-thumb {
            background: var(--accent);
            border-radius: 10px;
        }

        #strict-toggle-btn {
            position: fixed;
            top: 80px; /* Juste sous le bouton menu qui est √† 20px + sa hauteur */
            left: 20px;
            z-index: 1000;
            width: 45px;
            height: 45px;
            border-radius: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
            cursor: pointer;
            background: var(--glass);
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            color: var(--text-color);
            transition: all 0.3s ease;
        }

        /* Style quand le mode est activ√© (bouton plus "lumineux") */
        #strict-toggle-btn.active {
            background: rgba(255, 159, 67, 0.3); /* Teinte orange accent */
            border-color: var(--accent);
            box-shadow: 0 0 15px rgba(255, 159, 67, 0.4);
        }

        /* --- STYLE GLASSMORPHISM (√âcran Accueil) --- */
        .glass-card {
            background: var(--glass);
            backdrop-filter: blur(15px);
            padding: 40px; border-radius: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
            z-index: 10;
        }

        h1 { margin-top: 0; font-weight: 300; letter-spacing: 2px; }

        select {
            padding: 12px; border-radius: 10px; margin: 10px;
            background: rgba(255,255,255,0.9); border: none;
            font-size: 1rem; color: #0b132b;
            max-width: 250px; text-overflow: ellipsis;
        }

        select option {
            padding: 10px;
            font-size: 1rem;
        }

        /* Style pour la s√©lection par dur√©e */
        .duration-picker {
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .roulette-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
        }

        .roulette-container select {
            width: 70px;
            text-align: center;
            font-weight: bold;
            cursor: pointer;
        }

        .btn-random {
            background: transparent;
            color: var(--accent);
            border: 2px solid var(--accent);
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.3s;
        }

        .btn-random:hover {
            background: var(--accent);
            color: white;
        }

        /* Bouton d'ouverture */
        .btn-map-select {
            display: block; margin: 15px auto;
            padding: 8px 15px; background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 20px;
            color: var(--text-color); cursor: pointer; backdrop-filter: blur(5px);
            transition: 0.3s;
        }
        .btn-map-select:hover { background: var(--accent); color: white; transform: scale(1.05); }

        /* La Modale Plein √âcran */
        #map-modal {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6); /* Fond sombre derri√®re */
            z-index: 3000;
            display: flex; justify-content: center; align-items: center;
            backdrop-filter: blur(5px);
        }

        /* Le contenu de la modale */
        .map-modal-content {
            width: 90%; height: 80%;
            max-width: 1000px;
            display: flex; flex-direction: column;
            padding: 20px;
        }

        /* Titre de la modale */
        .map-modal-content h3 {
            color: rgba(255,255,255,0.9);
            margin-bottom: 5px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        /* Texte d'instruction (Cliquez sur un a√©roport...) */
        .map-modal-content p {
            color: rgba(255,255,255,0.9);
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        /* La carte de s√©lection */
        #selection-map {
            flex-grow: 1; /* Prend toute la place disponible */
            width: 100%;
            border-radius: 15px;
            margin: 15px 0;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .modal-buttons {
            display: flex; justify-content: space-around; align-items: center;
        }

        .marker-normal { /* Diff√©rents style de marqueurs pour les a√©roports sur la map de s√©lection*/
            stroke: #1a2a6c !important;
            fill: #1778bd !important;
            fill-opacity: 0.9 !important;
        }

        .marker-visited {
            stroke: #454cfc !important;
            fill: #8884f9e7 !important;
            fill-opacity: 0.4 !important;
        }
        /* Style D√©part (Vert) */
        .marker-departure {
            stroke: #1b5e20 !important;
            fill: #2ecc71 !important;
            fill-opacity: 0.8 !important;
        }

        /* Style Arriv√©e (Rouge) */
        .marker-arrival {
            stroke: #b71c1c !important;
            fill: #e74c3c !important;
            fill-opacity: 0.8 !important;
        }

        /* --- BOUTON D√âCOLLAGE --- */
        .btn-takeoff {
            position: fixed; bottom: 40px; right: 40px;
            padding: 20px 45px; background: var(--accent);
            border: none; border-radius: 50px; color: white;
            font-size: 1.2rem; font-weight: bold; cursor: pointer;
            box-shadow: 0 10px 20px var(--accent);
            transition: all 0.3s ease;
            z-index: 100;
        }
        .btn-takeoff:hover { transform: scale(1.05); background: var(--accent); filter: brightness(1.15); }

        /* --- √âCRAN DE VOL --- */
        #flight-screen {
            display: none; flex-direction: column; align-items: center;
            width: 100%; height: 100%; justify-content: center;
        }

        .timer-large {
            font-size: 5vw; font-weight: bold; margin-bottom: 10px;
            text-shadow: 0 4px 10px rgba(0,0,0,0.5);
            font-variant-numeric: tabular-nums; /* Optionnel : emp√™che les chiffres de "sauter" */
        }
        
        .progress-container {
            width: 60%; height: 8px; background: rgba(255,255,255,0.1);
            border-radius: 10px; margin-bottom: 30px; overflow: hidden;
        }
        #progress-bar { width: 0%; height: 100%; background: var(--accent); }

        #map {
            width: 70%; height: 45vh; border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .hidden { display: none !important; }
        
        /* Style de l'ic√¥ne avion sur la carte */
        .plane-icon {font-size: 24px; text-align: center; line-height: 24px; transition: all 1s linear; } /* L'avion met 1 seconde pour glisser vers sa nouvelle position */
        
        /* Bouton de retour √† la fin du vol */
        .btn-return {
            margin-top: 20px;
            padding: 12px 25px;
            background: var(--glass);
            color: var(--text-color);
            border: 1px solid rgba(128,128,128,0.5);
            border-radius: 15px;
            cursor: pointer;
            font-weight: bold;
            backdrop-filter: blur(5px);
            transition: 0.3s;
        }
        .btn-return:hover {
            background: var(--accent);
            color: white;
        }

        /* Emp√™che le d√©filement pendant le mode plein √©cran */
        :fullscreen {
            background-color: var(--bg-color);
        }

        /* Grille de 2x2 pour les succ√®s */
        #badge-list-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            padding: 10px;
        }

        /* Style de la carte individuelle */
        .badge-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            transition: transform 0.3s ease;
        }

        .badge-card h4 { margin: 8px 0; font-size: 1.1em; color: #fff; }

        /* Conteneur de la barre grise */
        .badge-progress-container {
            background: var(--accent);
            border-radius: 10px;
            height: 8px;
            width: 100%;
            margin: 10px 0;
            overflow: visible;
        }

        /* La barre de couleur qui progresse */
        .badge-progress-bar {
            height: 100%;
            border-radius: 10px;
            transition: width 1s ease-in-out;
            box-shadow: 0 0 10px rgba(46, 204, 113, 0.4);
        }

        /* Scrollbar personnalis√©e pour le glassomorphisme */
        #badge-list-container::-webkit-scrollbar {
            width: 6px;
        }
        #badge-list-container::-webkit-scrollbar-thumb {
            background: var(--accent);
            border-radius: 10px;
        }

        /* Bouton Info discret */
        .global-info-btn {
            position: absolute;
            top: 20px;
            right: 50px; /* √Ä gauche de la croix de fermeture */
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            color: white;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
        }
        .global-info-btn:hover {
            background: var(--accent);
        }

        /* Style de l'alerte d'info (ou tu peux r√©utiliser une modale existante) */
        #info-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8); /* Fond sombre */
            backdrop-filter: blur(5px);    /* Flou d'arri√®re-plan */
            display: none;                 /* Cach√© par d√©faut */
            justify-content: center;
            align-items: center;
            z-index: 3000;                 /* Au-dessus de tout le reste */
        }

        .info-box {
            background: #1a1a1a;
            padding: 30px;
            border-radius: 20px;
            max-width: 450px;
            width: 90%;
            max-height: 70vh; /* Limite la hauteur √† 70% de l'√©cran */
            border: 1px solid var(--accent);
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            text-align: left;
            display: flex;
            flex-direction: column;
        }
        #info-title {
            color: var(--accent);
            margin-bottom: 15px;
            font-size: 1.4em;
            text-align: center;
        }

        #info-text {
            color: #ddd;
            line-height: 1.6;
            font-size: 0.95em;
            white-space: pre-line; /* Respecte les sauts de ligne du JS */

            overflow-y: auto; /* Active le scroll si le texte d√©passe */
            padding-right: 10px; /* Espace pour la scrollbar */
            scrollbar-width: thin;
            scrollbar-color: var(--accent) transparent;
        }
        /* Style Webkit pour la scrollbar (Chrome, Safari, Edge) */
        #info-text::-webkit-scrollbar {
            width: 6px;
        }
        #info-text::-webkit-scrollbar-track {
            background: transparent;
        }
        #info-text::-webkit-scrollbar-thumb {
            background-color: var(--accent);
            border-radius: 20px;
            border: none;
        }

        .close-info-btn {
            display: block;
            margin: 20px auto 0;
            padding: 10px 20px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
        }

        .next-step { font-size: 0.75em; opacity: 0.6; }
        .current-rank { font-size: 0.85em; font-weight: bold; color: var(--accent); }


        @media (max-width: 600px) {
            @media (orientation: landscape) or (max-height: 500px){
                body { overflow-x: auto !important ; height: auto; min-height: 100vh; width: auto; min-width: 100vw; }
                .timer-large { font-size: 10vh; }
                #settings-panel { width: 100vw; padding-bottom: 40px; overflow-y: auto; }
                #flight-screen {overflow-y: auto; overflow-x: auto;    /* Active le scroll vertical et horizontal interne au menu */}
            }
            @media (orientation: portrait){
                body { overflow-y: auto !important ; height: auto; min-height: 100vh; }
                .timer-large { font-size: 15vw; } /* Plus gros sur mobile */
                #settings-panel { width: 50vw; }
                #badge-list-container { grid-template-columns: 1fr; gap: 15px; } /* 1 seule colonne sur petit mobile */
            }

            .glass-card { width: 90%; padding: 20px; margin : 20px; position : relative;}
            .btn-takeoff { position: fixed; bottom: 20px; right: 20px; padding: 15px 30px; z-index : 100; }

            main, .container { padding-bottom: 100px; }

            #history-list-box { max-height: 60vh; } /* On donne un peu plus d'espace sur mobile */ 
    
            /* On r√©duit l√©g√®rement la taille du texte pour que √ßa tienne sur une ligne */
            #history-table-body td { font-size: 0.85em; }

            #info-overlay .info-box { width: 90vw; max-width: none; height: 70vh; }
        }
  
    </style>
</head>
<body>
    <button id="menu-toggle" onclick="toggleMenu()">‚öôÔ∏è</button>

    <button id="strict-toggle-btn" class="glass-btn" onclick="toggleStrictVisual()" title="Mode Strict">üîì</button>
    <input type="checkbox" id="strict-mode" class="hidden">

    <div id="settings-panel" class="glass-card hidden">
        <h3>R√©glages</h3>

        <div class="setting-item">
            <label>Ambiance Cabine</label>
            <input type="checkbox" id="ambient-toggle" onchange="updateAmbient()">
        </div>
        <div class="setting-item">
            <label>Type de son</label>
            <select id="ambient-type" onchange="changeAmbientType()">
                <option value="ambiance1.mp3">Cabine Standard</option>
                <option value="ambiance2.mp3">Cabine B737</option>
                <option value="cessna.mp3">Cabine Cessna</option>
                <option value="atmos.mp3">Cabine vol atmosph√©rique</option>
            </select>
        </div>
        <div class="setting-item">
            <label>Volume</label>
            <input type="range" id="volume-slider" min="0" max="1" step="0.1" value="0.5" oninput="updateAmbient()">
        </div>

        <div class="setting-item">
            <span>Plein √©cran</span>
            <button onclick="toggleFullscreen()" class="glass-btn-small">üì∫</button>
        </div>

        <button onclick="openHistoryModal()" class="menu-btn-history">üìä Historique</button>

        <button onclick="openBadgeModal()" class="menu-btn-history">
            <span>üèÜ</span> Mes Succ√®s
        </button>

        <button class="btn-random" onclick="toggleMenu()">Fermer</button>
    </div>

    <button id="theme-switcher" onclick="toggleTheme()">üåì Changer de vue</button>

    <div id="selection-screen" class="glass-card">
        <h1>‚úàÔ∏è FOCUS FLIGHT</h1>
        <p>Configurez votre voyage de concentration</p>
        <div>
            <select id="origin"></select>
            <span> vers </span>
            <select id="destination"></select>
        </div>

        <button class="btn-map-select" onclick="openSelectionMap()">üåç Choisir sur la carte</button>

        <div class="duration-picker">
            <p>Ou d√©finissez un temps de focus :</p>
            <div class="roulette-container">
                <select id="pick-hours"></select> H : 
                <select id="pick-mins"></select> M
            </div>
            <button class="btn-random" onclick="proposeRandomFlight()">üé≤ Proposer un trajet al√©atoire</button>
        </div>
        <p id="estimated-time" style="color: var(--accent); font-weight: bold; margin-top: 20px;">Dur√©e : -- min</p>
    </div>

    <div id="map-modal" class="hidden">
        <div class="map-modal-content glass-card">
            <h3>üìç Cr√©ez votre plan de vol</h3>
            <p>Cliquez sur un a√©roport de d√©part, puis un d'arriv√©e.</p>
        
            <div id="selection-map"></div>
        
            <div class="modal-buttons">
                <button class="btn-return" onclick="closeSelectionMap()">Annuler</button>
                <button id="btn-confirm-route" class="btn-takeoff hidden" onclick="confirmRouteSelection()" style="position: static; padding: 10px 20px;">Valider ce trajet</button>
            </div>
        </div>
    </div>

    <div id="history-modal">
        <div class="history-content-glass">
            
            <div class="history-title-bar" style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 20px;">
                <h2 style="color: var(--accent); margin-top: 0;">Journal de Bord</h2>
                <div id="total-focus-time" style="font-size: 0.9em; font-weight: 500; color: var(--text-color); opacity: 0.8;">
                    Temps total : 0 min
                </div>
            </div>

            <div id="history-header" style="padding: 0 15px;">
                <table style="width:100%; border-collapse: collapse; color: var(--text-color); opacity: 0.8; font-size: 0.75em;">
                    <thead>
                        <tr>
                            <th style="padding: 10px 5px; border-bottom: 2px solid var(--accent); text-align: left; width: 60%;">TRAJET</th>
                            <th style="padding: 10px 5px; border-bottom: 2px solid var(--accent); text-align: center; width: 15%;">VOLS</th>
                            <th style="padding: 10px 5px; border-bottom: 2px solid var(--accent); text-align: right; width: 25%;">TOTAL</th>
                        </tr>
                    </thead>
                </table>
            </div>

            <div id="history-list-box" style="max-height: 40vh; overflow-y: auto; padding: 0 15px;">
                <table id="history-table-body" style="width:100%; border-collapse: collapse; color: var(--text-color);">
                    </table>
            </div>

            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button onclick="clearHistory()" style="background: rgba(231, 76, 60, 0.2); color: #e74c3c; border: 1px solid #e74c3c; padding: 10px 15px; border-radius: 10px; cursor: pointer;">R√©initialiser</button>
                <button onclick="closeHistoryModal()" style="background: var(--accent); color: white; border: none; padding: 10px 20px; border-radius: 10px; cursor: pointer; font-weight: bold;">Fermer</button>
            </div>
        </div>
    </div>

    <button class="btn-takeoff" id="btn-go" onclick="takeOff()">D√âCOLLAGE</button>

    <div id="flight-screen">
        <div id="flight-info" style="letter-spacing: 3px; margin-bottom: 10px; opacity: 0.8;">VOL EN COURS VERS <span id="dest-name">...</span></div>
        <div class="timer-large" id="timerDisplay">00:00</div>
        <div class="progress-container"><div id="progress-bar"></div></div>
        <div id="map"></div>
        <button id="btn-home" class="btn-return hidden" onclick="resetToHome()">üè† Retour au terminal</button>
    </div>

    <div id="arrival-modal" class="glass-card hidden" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 2000; width: 300px;">
        <h2 style="color: var(--accent);">üõ¨ BIENVENUE !</h2>
        <p>Votre session de focus est termin√©e avec succ√®s.</p>
        <button class="btn-takeoff" style="position: static; margin-top: 20px;" onclick="closeArrivalModal()">OK</button>
    </div>

    <div id="modal-overlay" class="hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(5px); z-index: 1999;"></div>

    <div id="badge-modal" class="modal" style="display:none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(5px);">
        <div class="modal-content" style="background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.2); width: 90%; max-width: 75vh; border-radius: 20px; padding: 25px; color: white; position: relative; box-shadow: 0 8px 32px rgba(0,0,0,0.5);">
        
            <span onclick="closeBadgeModal()" style="position: absolute; top: 15px; right: 20px; cursor: pointer; font-size: 1.5em; opacity: 0.7;">&times;</span>

            <div class="modal-header">
                <button class="global-info-btn" onclick="showAllBadgesHelp()">‚ìò</button>
                <h2>Tableau des Troph√©es</h2>
            </div>

            <div class="badge-header" style="text-align: center; margin-bottom: 25px;">
                <h2 style="margin: 0; color: var(--accent);">Tableau des Troph√©es</h2>
                <p style="font-size: 0.9em; opacity: 0.7;">Vos exploits en tant que pilote chez Focus Airlines</p>
            </div>

            <div id="badge-list-container" style="max-height: 40vh; overflow-y: auto; padding-right: 10px;">
                <p style="text-align: center; opacity: 0.5; padding: 20px;">Chargement de vos m√©dailles...</p>
            </div>

            <div style="margin-top: 25px; text-align: center;">
                <button onclick="closeBadgeModal()" style="background: var(--accent); border: none; padding: 10px 25px; border-radius: 25px; color: white; cursor: pointer; font-weight: bold;">Fermer</button>
            </div>
        </div>
    </div>

    <div id="info-overlay" onclick="this.style.display='none'">
        <div class="info-box" onclick="event.stopPropagation()">
            <h3 id="info-title"></h3>
            <div id="info-text"></div>

            <button class="close-info-btn" onclick="document.getElementById('info-overlay').style.display='none'">Compris</button>
        </div>
    </div>

    <script>
        let currentTheme = 'dark'; // √âtat initial
        let tileLayer; // On cr√©e une variable pour stocker la couche de la carte
        let flightEndTime; // Stockera le timestamp (en millisecondes) de l'atterrissage
        let isAutoCenterEnabled = true; // L'interrupteur
        let autoCenterTimeout; // Le compte √† rebours avant r√©activation
        let dingTimers = []; // Tableau pour stocker les chronom√®tres des dings

        // Sons : modifier les fichiers mp3 dans HTML pour ajouter des sons
        const ambientSound = new Audio('ambiance.mp3');
        ambientSound.loop = true;

        // On d√©finit la source par d√©faut tout de suite pour √©viter le "vide"
        ambientSound.src = document.getElementById('ambient-type')?.value || 'ambiance.mp3';

        const dingSound = new Audio('ding.mp3'); // Un "ding" clair

        function toggleMenu() {
            document.getElementById('settings-panel').classList.toggle('hidden');
            // On profite de l'ouverture du menu pour "pr√©-charger" les sons
            // On ne fait LOAD que si le son est en pause (au tout d√©but) pour √©viter de couper le son en plein vol
            if (ambientSound.paused) {
                ambientSound.load();
                dingSound.load();
            }
        }

        function changeAmbientType() {
            const selectedFile = document.getElementById('ambient-type').value;
    
            // On m√©morise si le son √©tait en train de jouer
            const wasPlaying = !ambientSound.paused;
    
            // On change la source
            ambientSound.src = selectedFile;
            ambientSound.load(); // FORCE le navigateur √† pr√©parer le fichier
    
            // Si le son tournait, on relance le nouveau fichier imm√©diatement
            if (wasPlaying) {
                ambientSound.play().catch(e => console.warn("Attente d'interaction"));
            }
        }

        function updateAmbient() {
            const isActive = document.getElementById('ambient-toggle').checked;
            const volume = document.getElementById('volume-slider').value;
            const isFlying = document.getElementById('flight-screen').style.display === 'flex';
    
            ambientSound.volume = volume;
    
            if (isActive && isFlying) {
                // Le secret : on appelle load() si le son est √† l'arr√™t pour le "r√©veiller"
                if (ambientSound.paused) {
                    ambientSound.load(); 
                    // On utilise un petit d√©lai pour laisser le temps au chargement
                    ambientSound.play()
                        .then(() => console.log("Audio d√©marr√© !"))
                        .catch(e => {
                            console.log("Le navigateur bloque encore. On r√©essaiera au prochain clic.");
                        });
                }
            } else {
                ambientSound.pause();
            }
        }

        function toggleTheme() {
            const themes = ['light', 'mixed', 'dark'];
            // On passe au th√®me suivant dans le tableau
            currentTheme = themes[(themes.indexOf(currentTheme) + 1) % themes.length];
    
            // On applique l'attribut au HTML pour que le CSS change
            document.documentElement.setAttribute('data-theme', currentTheme);
    
            // Si la carte existe d√©j√†, on met √† jour son style
            if (map) {
                updateMapStyle();
            }
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => alert(`Erreur : ${err.message}`));
            } else {
                document.exitFullscreen();
            }
        }

        function toggleStrictVisual() {
            const btn = document.getElementById('strict-toggle-btn');
            const checkbox = document.getElementById('strict-mode');
    
            checkbox.checked = !checkbox.checked; // Inverse l'√©tat

            if (checkbox.checked) {
                btn.classList.add('active');
                btn.innerHTML = "üîí";
                // SI ON EST EN VOL : On verrouille imm√©diatement !
                const isFlying = document.getElementById('flight-screen').style.display === 'flex';
                if (isFlying) {
                    document.getElementById('menu-toggle').classList.add('hidden');
                    document.getElementById('theme-switcher').classList.add('hidden');
                    // Optionnel : cacher le bouton de verrouillage lui-m√™me maintenant qu'il est ferm√©
                    btn.classList.add('hidden'); 
                    enableFocusPrison();
                }
            } else {
                btn.classList.remove('active');
                btn.innerHTML = "üîì";
            }
        }

        function updateMapStyle() {
            // Si une couche de carte existe, on l'enl√®ve pour mettre la nouvelle
            if (tileLayer) map.removeLayer(tileLayer);
    
            let url;
            // Mode Dark -> Carte sombre. Modes Light et Mixed -> Carte claire.
            if (currentTheme === 'dark') {
                url = 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png';
            } else {
                url = 'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png';
            }
    
            tileLayer = L.tileLayer(url).addTo(map);

            // On r√©cup√®re la couleur de ligne d√©finie dans le CSS (variable --line-color)
            const color = getComputedStyle(document.documentElement).getPropertyValue('--line-color').trim();
            if (flightLine) {
                flightLine.setStyle({ color: color });
            }
        }
        // Remplir la roulette des heures
        const hSelect = document.getElementById('pick-hours');
        for(let i=0; i<24; i++) {
            hSelect.innerHTML += `<option value="${i}">${i.toString().padStart(2, '0')}</option>`;
        }

        // Remplir la roulette des minutes (par pas de 5 pour plus de simplicit√©)
        const mSelect = document.getElementById('pick-mins');
        for(let i=0; i<60; i+=5) {
            mSelect.innerHTML += `<option value="${i}">${i.toString().padStart(2, '0')}</option>`;
        }

        function formatTimeHHMMSS(totalSeconds) {
            const h = Math.floor(totalSeconds / 3600);
            const m = Math.floor((totalSeconds % 3600) / 60);
            const s = totalSeconds % 60;

            // On utilise padStart pour forcer 2 chiffres (01:05:08 au lieu de 1:5:8)
            const hours = h.toString().padStart(2, '0');
            const minutes = m.toString().padStart(2, '0');
            const seconds = s.toString().padStart(2, '0');

            return `${hours}:${minutes}:${seconds}`;
        }

        const airports = [
            // --- BENELUX & PROXIMIT√â ---
            { id: "BRU", name: "Bruxelles-National", lat: 50.9014, lon: 4.4844, country: "Belgique" },
            { id: "CRL", name: "Charleroi (Sud)", lat: 50.4592, lon: 4.4538, country: "Belgique" },
            { id: "CDG", name: "Paris Charles de Gaulle", lat: 49.0097, lon: 2.5479, country: "France" },
            { id: "NCE", name: "Nice C√¥te d'Azur", lat: 43.6653, lon: 7.2150, country: "France" },
            { id: "LBG", name: "Paris - Le Bourget LBG", lat: 48.9694, lon: 2.4414, country: "France" },
            { id: "ORY", name: "Paris Orly", lat: 48.7262, lon: 2.3652, country: "France" },
            { id: "LGG", name: "Li√®ge Airport", lat: 50.6374, lon: 5.4432, country: "Belgique" },
            { id: "ANR", name: "Anvers-Deurne", lat: 51.1894, lon: 4.4603, country: "Belgique" },
            { id: "LUX", name: "Luxembourg Findel", lat: 49.6233, lon: 6.2044, country: "Luxembourg" },
            { id: "LIL", name: "Lille Lesquin", lat: 50.5619, lon: 3.0894, country: "France" },
            { id: "RTM", name: "Rotterdam The Hague", lat: 51.9569, lon: 4.4372, country: "Pays-Bas" },
            { id: "EIN", name: "Eindhoven Airport", lat: 51.4501, lon: 5.3745, country: "Pays-Bas" },
            { id: "SXB", name: "Strasbourg Entzheim", lat: 48.5383, lon: 7.6282, country: "France" },
            { id: "BSL", name: "B√¢le-Mulhouse", lat: 47.5900, lon: 7.5292, country: "France" },

            // --- EUROPE (AJOUTS) --- 
            { id: "LHR", name: "Londres Heathrow", lat: 51.4700, lon: -0.4543, country: "Royaume-Uni" },
            { id: "LGW", name: "Londres Gatwick", lat: 51.1481, lon: -0.1903, country: "Royaume-Uni" },
            { id: "MAD", name: "Madrid Barajas", lat: 40.4839, lon: -3.5680, country: "Espagne" },
            { id: "BER", name: "Berlin Brandenburg", lat: 52.3667, lon: 13.5033, country: "Allemagne" },
            { id: "FCO", name: "Rome Fiumicino", lat: 41.8003, lon: 12.2389, country: "Italie" },
            { id: "AMS", name: "Amsterdam Schiphol", lat: 52.3105, lon: 4.7683, country: "Pays-Bas" },
            { id: "LIS", name: "Lisbonne Humberto Delgado", lat: 38.7742, lon: -9.1342, country: "Portugal" },
            { id: "ATH", name: "Ath√®nes Elefth√©rios-Veniz√©los", lat: 37.9364, lon: 23.9445, country: "Gr√®ce" },
            { id: "GVA", name: "Gen√®ve A√©roport", lat: 46.2370, lon: 6.1091, country: "Suisse" },
            { id: "DUB", name: "Dublin Airport", lat: 53.4264, lon: -6.2499, country: "Irlande" },
            { id: "OSL", name: "Oslo Gardermoen", lat: 60.1976, lon: 11.1004, country: "Norv√®ge" },
            { id: "FRA", name: "Francfort-sur-le-Main", lat: 50.0379, lon: 8.5622, country: "Allemagne" },
            { id: "ZRH", name: "Zurich Kloten", lat: 47.4582, lon: 8.5555, country: "Suisse" },
            { id: "MUC", name: "Munich Franz-Josef-Strauss", lat: 48.3537, lon: 11.7861, country: "Allemagne" },
            { id: "VIE", name: "Vienne-Schwechat", lat: 48.1103, lon: 16.5697, country: "Autriche" },
            { id: "PRG", name: "Prague V√°clav-Havel", lat: 50.1008, lon: 14.2600, country: "R√©publique Tch√®que" },
            { id: "BCN", name: "Barcelone El Prat", lat: 41.2974, lon: 2.0833, country: "Espagne" },
            { id: "PMI", name: "Palma de Majorque", lat: 39.5517, lon: 2.7388, isIsland: true, country: "Espagne" },
            { id: "MRS", name: "Marseille Provence", lat: 43.4367, lon: 5.2150, country: "France" },
            { id: "CPH", name: "Copenhague Kastrup", lat: 55.6180, lon: 12.6508, country: "Danemark" },
            { id: "HEL", name: "Helsinki Vantaa", lat: 60.3172, lon: 24.9633, country: "Finlande" },
            { id: "IST", name: "Istanbul Airport", lat: 41.2753, lon: 28.7519, country: "Turquie" },
            { id: "DME", name: "Moscou Domodedovo", lat: 55.4086, lon: 37.9061, country: "Russie" },
            { id: "KEF", name: "Reykjavik Keflavik", lat: 63.9850, lon: -22.6056, isIsland: true, country: "Islande" },
            { id: "VCE", name: "Venise Marco Polo", lat: 45.5053, lon: 12.3519, country: "Italie" },
            { id: "SOU", name: "Southampton", lat: 50.9503, lon: -1.3567, country: "Royaume-Uni" },
            { id: "BOH", name: "Bournemouth", lat: 50.7800, lon: -1.8425, country: "Royaume-Uni" },
            { id: "LIN", name: "Milan Linate", lat: 45.4451, lon: 9.2767, country: "Italie" },
            { id: "MXP", name: "Milan Malpensa", lat: 45.6300, lon: 8.7231, country: "Italie" },
            { id: "STN", name: "Londres Stansted", lat: 51.8860, lon: 0.2389, country: "Royaume-Uni" },
            { id: "LCY", name: "Londres City", lat: 51.5053, lon: 0.0553, country: "Royaume-Uni" },
            { id: "CIA", name: "Rome Ciampino", lat: 41.7994, lon: 12.5949, country: "Italie" },
            { id: "DUS", name: "D√ºsseldorf Intl", lat: 51.2895, lon: 6.7668, country: "Allemagne" },
            { id: "CGN", name: "Cologne/Bonn", lat: 50.8659, lon: 7.1427, country: "Allemagne" },
            { id: "LYS", name: "Lyon Saint-Exup√©ry", lat: 45.7256, lon: 5.0811, country: "France" },
            { id: "TXL", name: "Berlin Tegel", lat: 52.5597, lon: 13.2877, country: "Allemagne" }, 
            { id: "LEJ", name: "Leipzig/Halle", lat: 51.4324, lon: 12.2416, country: "Allemagne" },
            { id: "IBZ", name: "Ibiza Airport", lat: 38.8728, lon: 1.3731, isIsland: true, country: "Espagne" },
            { id: "MAH", name: "Minorque", lat: 39.8626, lon: 4.2186, country: "Espagne" },
            { id: "JTR", name: "Santorin (Thira)", lat: 36.3992, lon: 25.4793, isIsland: true, country: "Gr√®ce" },
            { id: "JMK", name: "Mykonos", lat: 37.4351, lon: 25.3481, isIsland: true, country: "Gr√®ce" },
            { id: "HER", name: "H√©raklion (Cr√®te)", lat: 35.3397, lon: 25.1803, isIsland: true, country: "Gr√®ce" },
            { id: "AJA", name: "Ajaccio Napol√©on Bonaparte", lat: 41.9238, lon: 8.8025, isIsland: true, country: "France" },
            { id: "BIA", name: "Bastia Poretta", lat: 42.5527, lon: 9.4837, isIsland: true, country: "France" },
            { id: "CAG", name: "Cagliari Elmas", lat: 39.2515, lon: 9.0543, isIsland: true, country: "Italie" },
            { id: "AYT", name: "Antalya Turkiye", lat: 36.8987, lon: 30.7925, country: "Turquie" },
            { id: "DBV", name: "Dubrovnik Croatie", lat: 42.5614, lon: 18.2615, country: "Croatie" },
            { id: "LCA", name: "Larnaca Chypre", lat: 34.8723, lon: 33.6203, isIsland: true, country: "Chypre" },
            { id: "OTP", name: "Bucarest Henri CoandƒÉ", lat: 44.5707, lon: 26.0844, country: "Roumanie" },

            // --- AFRIQUE (AJOUTS) ---
            { id: "CAI", name: "Le Caire Intl", lat: 30.1219, lon: 31.4056, country: "√âgypte" },
            { id: "JNB", name: "Johannesburg O.R. Tambo", lat: -26.1367, lon: 28.2461, country: "Afrique du Sud" },
            { id: "CMN", name: "Casablanca Mohammed V", lat: 33.3675, lon: -7.5899, country: "Maroc" },
            { id: "NBO", name: "Nairobi Jomo Kenyatta", lat: -1.3192, lon: 36.9275, country: "Kenya" },
            { id: "CPT", name: "Le Cap Intl", lat: -33.9715, lon: 18.6021, country: "Afrique du Sud" },
            { id: "DSS", name: "Dakar Blaise Diagne", lat: 14.6711, lon: -17.0673, country: "S√©n√©gal" },
            { id: "RAK", name: "Marrakech-M√©nara", lat: 31.6069, lon: -8.0363, country: "Maroc" },
            { id: "RUN", name: "La R√©union Roland-Garros", lat: -20.8872, lon: 55.5103, isIsland: true, country: "France" },
            { id: "MRU", name: "Maurice Sir Seewoosagur", lat: -20.4300, lon: 57.6836, isIsland: true, country: "Maurice" },
            { id: "TFN", name: "Tenerife Nord", lat: 28.4827, lon: -16.3415, isIsland: true, country: "Espagne" },
            { id: "TFS", name: "Tenerife Sud", lat: 28.0445, lon: -16.5725, isIsland: true, country: "Espagne" },
            { id: "LPA", name: "Gran Canaria", lat: 27.9319, lon: -15.3866, isIsland: true, country: "Espagne" },
            { id: "FNC", name: "Mad√®re (Funchal)", lat: 32.6941, lon: -16.7779, isIsland: true, country: "Portugal" },
            { id: "PDL", name: "A√ßores (Ponta Delgada)", lat: 37.7412, lon: -25.6979, isIsland: true, country: "Portugal" },
            { id: "AGA", name: "Agadir Al Massira", lat: 30.3250, lon: -9.4107, country: "Maroc" },
            { id: "TNG", name: "Tanger Ibn Battouta", lat: 35.7269, lon: -5.9169, country: "Maroc" },
            { id: "TUN", name: "Tunis-Carthage", lat: 36.8510, lon: 10.2272, country: "Tunisie" },
            { id: "DJE", name: "Djerba-Zarzis", lat: 33.8750, lon: 10.7755, isIsland: true, country: "Tunisie" },
            { id: "ALG", name: "Alger Houari Boum√©di√®ne", lat: 36.6910, lon: 3.2154, country: "Alg√©rie" },
            { id: "ORN", name: "Oran Ahmed Ben Bella", lat: 35.6239, lon: -0.6212, country: "Alg√©rie" },
            { id: "BZV", name: "Brazzaville Maya-Maya", lat: -4.2517, lon: 15.2530, country: "Congo" },
            { id: "FIH", name: "Kinshasa Ndjili", lat: -4.3858, lon: 15.4470, country: "RD Congo" },
            { id: "LOS", name: "Lagos Murtala Muhammed", lat: 6.5774, lon: 3.3210, country: "Nig√©ria" },
            { id: "ABV", name: "Abuja Intl", lat: 9.0068, lon: 7.2631, country: "Nig√©ria" },
            { id: "ACC", name: "Accra Kotoka", lat: 5.6051, lon: -0.1668, country: "Ghana" },
            { id: "ABJ", name: "Abidjan F√©lix Houphou√´t-Boigny", lat: 5.2614, lon: -3.9263, country: "C√¥te d'Ivoire" },
            { id: "DKR", name: "Dakar (Ancien)", lat: 14.7397, lon: -17.4902, country: "S√©n√©gal" },
            { id: "ADD", name: "Addis-Abeba Bole", lat: 8.9779, lon: 38.7993, country: "√âthiopie" },
            { id: "ZNZ", name: "Zanzibar Abeid Amani Karume", lat: -6.2220, lon: 39.2247, isIsland: true, country: "Tanzanie" },
            { id: "DAR", name: "Dar es Salam Julius Nyerere", lat: -6.8781, lon: 39.2026, country: "Tanzanie" },
            { id: "EBB", name: "Entebbe (Ouganda)", lat: 0.0424, lon: 32.4435, country: "Ouganda" },
            { id: "KGL", name: "Kigali (Rwanda)", lat: -1.9686, lon: 30.1395, country: "Rwanda" },
            { id: "DUR", name: "Durban King Shaka", lat: -29.6144, lon: 31.1197, country: "Afrique du Sud" },
            { id: "PLZ", name: "Port Elizabeth Intl", lat: -33.9846, lon: 25.6173, country: "Afrique du Sud" },
            { id: "GRJ", name: "George Airport", lat: -34.0056, lon: 22.3789, country: "Afrique du Sud" },
            { id: "WDH", name: "Windhoek Hosea Kutako", lat: -22.4799, lon: 17.4709, country: "Namibie" },
            { id: "VFA", name: "Victoria Falls", lat: -18.0959, lon: 25.8390, country: "Zimbabwe" },

            // --- AM√âRIQUE DU NORD (AJOUTS) ---
            { id: "JFK", name: "New York JFK", lat: 40.6413, lon: -73.7781, country: "USA" },
            { id: "LAX", name: "Los Angeles Intl", lat: 33.9416, lon: -118.4085, country: "USA" },
            { id: "ORD", name: "Chicago O'Hare", lat: 41.9742, lon: -87.9073, country: "USA" },
            { id: "MIA", name: "Miami Intl", lat: 25.7959, lon: -80.2870, country: "USA" },
            { id: "YYZ", name: "Toronto Pearson", lat: 43.6777, lon: -79.6248, country: "Canada" },
            { id: "YVR", name: "Vancouver Intl", lat: 49.1967, lon: -123.1815, country: "Canada" },
            { id: "MEX", name: "Mexico City Benito Ju√°rez", lat: 19.4361, lon: -99.0719, country: "Mexique" },
            { id: "SFO", name: "San Francisco Intl", lat: 37.6213, lon: -122.3790, country: "USA" },
            { id: "DEN", name: "Denver Intl", lat: 39.8561, lon: -104.6737, country: "USA" },
            { id: "YUL", name: "Montr√©al-Trudeau", lat: 45.4657, lon: -73.7455, country: "Canada" },
            { id: "HNL", name: "Honolulu (Hawa√Ø)", lat: 21.3186, lon: -157.9225, isIsland: true, country: "USA" },
            { id: "LAS", name: "Las Vegas McCarran", lat: 36.0840, lon: -115.1537, country: "USA" },
            { id: "SEA", name: "Seattle-Tacoma", lat: 47.4502, lon: -122.3088, country: "USA" },
            { id: "DFW", name: "Dallas/Fort Worth", lat: 32.8998, lon: -97.0403, country: "USA" },
            { id: "IAH", name: "Houston George Bush", lat: 29.9902, lon: -95.3368, country: "USA" },
            { id: "SNA", name: "Orange County (LA)", lat: 33.6762, lon: -117.8675, country: "USA" },
            { id: "OAK", name: "Oakland Intl", lat: 37.7126, lon: -122.2132, country: "USA" },
            { id: "SXM", name: "Saint-Martin", lat: 18.0410, lon: -63.1090, isIsland: true, country: "Sint Maarten" },
            { id: "SBH", name: "Saint-Barth√©lemy", lat: 17.9044, lon: -62.8437, isIsland: true, country: "France" },
            { id: "PTP", name: "Guadeloupe", lat: 16.2635, lon: -61.5318, isIsland: true, country: "France" },
            { id: "FDF", name: "Martinique", lat: 14.5910, lon: -61.0032, isIsland: true, country: "France" },
            { id: "NAS", name: "Nassau (Bahamas)", lat: 25.0389, lon: -77.4662, isIsland: true, country: "Bahamas" },
            { id: "PUJ", name: "Punta Cana", lat: 18.5674, lon: -68.3634, isIsland: true, country: "R√©publique Dominicaine" },
            { id: "MBJ", name: "Montego Bay", lat: 18.5037, lon: -77.9133, isIsland: true, country: "Jama√Øque" },

            // --- AM√âRIQUE DU SUD (AJOUTS) ---
            { id: "GRU", name: "S√£o Paulo Guarulhos", lat: -23.4356, lon: -46.4731, country: "Br√©sil" },
            { id: "EZE", name: "Buenos Aires Ezeiza", lat: -34.8222, lon: -58.5358, country: "Argentine" },
            { id: "BOG", name: "Bogota El Dorado", lat: 4.7016, lon: -74.1469, country: "Colombie" },
            { id: "LIM", name: "Lima Jorge Ch√°vez", lat: -12.0219, lon: -77.1143, country: "P√©rou" },
            { id: "SCL", name: "Santiago Comodoro Arturo", lat: -33.3930, lon: -70.7858, country: "Chili" },
            { id: "GIG", name: "Rio de Janeiro Gale√£o", lat: -22.8100, lon: -43.2506, country: "Br√©sil" },
            { id: "BSB", name: "Bras√≠lia Intl", lat: -15.8697, lon: -47.9208, country: "Br√©sil" },
            { id: "CNF", name: "Belo Horizonte Confins", lat: -19.6244, lon: -43.9719, country: "Br√©sil" },
            { id: "COR", name: "C√≥rdoba", lat: -31.3100, lon: -64.2081, country: "Argentine" },
            { id: "MDZ", name: "Mendoza El Plumerillo", lat: -32.8317, lon: -68.7928, country: "Argentine" },
            { id: "ANF", name: "Antofagasta (Chili)", lat: -23.4445, lon: -70.4451, country: "Chili" },
            { id: "MDE", name: "Medell√≠n Jos√© Mar√≠a C√≥rdova", lat: 6.1645, lon: -75.4231, country: "Colombie" },
            { id: "CLO", name: "Cali Alfonso Bonilla Arag√≥n", lat: 3.5432, lon: -76.3816, country: "Colombie" },
            { id: "UIO", name: "Quito Mariscal Sucre", lat: -0.1292, lon: -78.3575, country: "√âquateur" },
            { id: "GYE", name: "Guayaquil", lat: -2.1509, lon: -79.8835, country: "√âquateur" },
            { id: "VVI", name: "Santa Cruz Viru Viru", lat: -17.6447, lon: -63.1353, country: "Bolivie" },

            // --- ASIE (AJOUTS) ---
            { id: "HND", name: "Tokyo Haneda", lat: 35.5494, lon: 139.7798, country: "Japon" },
            { id: "NRT", name: "Tokyo Narita", lat: 35.7720, lon: 140.3929, country: "Japon" },
            { id: "ICN", name: "S√©oul Incheon", lat: 37.4602, lon: 126.4407, country: "Cor√©e du Sud" },
            { id: "SIN", name: "Singapour Changi", lat: 1.3644, lon: 103.9915, country: "Singapour" },
            { id: "HKG", name: "Hong Kong Intl", lat: 22.3080, lon: 113.9185, country: "Hong Kong" },
            { id: "DXB", name: "Duba√Ø Intl", lat: 25.2532, lon: 55.3657, country: "√âmirats Arabes Unis" },
            { id: "BKK", name: "Bangkok Suvarnabhumi", lat: 13.6900, lon: 100.7501, country: "Tha√Ølande" },
            { id: "DEL", name: "New Delhi Indira Gandhi", lat: 28.5562, lon: 77.1000, country: "Inde" },
            { id: "BJS", name: "P√©kin Capital", lat: 40.0799, lon: 116.6031, country: "Chine" },
            { id: "DOH", name: "Doha Hamad", lat: 25.2731, lon: 51.6081, country: "Qatar" },
            { id: "KUL", name: "Kuala Lumpur Intl", lat: 2.7456, lon: 101.7072, country: "Malaisie" },
            { id: "DPS", name: "Bali Denpasar", lat: -8.7482, lon: 115.1672, isIsland: true, country: "Indon√©sie" },
            { id: "SGN", name: "H√¥ Chi Minh-Ville", lat: 10.8185, lon: 106.6588, country: "Vietnam" },
            { id: "MLE", name: "Mal√© (Maldives)", lat: 4.1918, lon: 73.5291, isIsland: true, country: "Maldives" },
            { id: "CGK", name: "Jakarta Soekarno-Hatta", lat: -6.1256, lon: 106.6559, country: "Indon√©sie" },
            { id: "MNL", name: "Manille Ninoy Aquino", lat: 14.5086, lon: 121.0194, isIsland: true, country: "Philippines" },
            { id: "AUH", name: "Abou Dabi Intl", lat: 24.4330, lon: 54.6511, country: "√âmirats Arabes Unis" }, 
            { id: "SHJ", name: "Sharjah Intl", lat: 25.3286, lon: 55.5172, country: "√âmirats Arabes Unis" }, 
            { id: "GMP", name: "S√©oul Gimpo", lat: 37.5583, lon: 126.7906, country: "Cor√©e du Sud" },
            { id: "KIX", name: "Osaka Kansai", lat: 34.4320, lon: 135.2304, country: "Japon" },
            { id: "PVG", name: "Shanghai Pudong", lat: 31.1443, lon: 121.8083, country: "Chine" },
            { id: "SHA", name: "Shanghai Hongqiao", lat: 31.1979, lon: 121.3363, country: "Chine" },
            { id: "CAN", name: "Guangzhou Baiyun", lat: 23.3924, lon: 113.2988, country: "Chine" },
            { id: "SZX", name: "Shenzhen Bao'an", lat: 22.6393, lon: 113.8107, country: "Chine" },
            { id: "TPE", name: "Taipei Taoyuan", lat: 25.0797, lon: 121.2342, isIsland: true, country: "Ta√Øwan" },
            { id: "ITM", name: "Osaka Itami", lat: 34.7855, lon: 135.4382, country: "Japon" },
            { id: "CTS", name: "Sapporo New Chitose", lat: 42.7752, lon: 141.6923, country: "Japon" },
            { id: "BOM", name: "Mumbai", lat: 19.0896, lon: 72.8656, country: "Inde" },
            { id: "BLR", name: "Bangalore", lat: 13.1986, lon: 77.7066, country: "Inde" },
            { id: "DAD", name: "Da Nang Intl", lat: 16.0439, lon: 108.1994, country: "Vietnam" },
            { id: "SVO", name: "Moscou Sheremetyevo", lat: 55.9726, lon: 37.4146, country: "Russie" },
            { id: "VKO", name: "Moscou Vnukovo", lat: 55.5915, lon: 37.2615, country: "Russie" },
            { id: "LED", name: "St-P√©tersbourg", lat: 59.8003, lon: 30.2625, country: "Russie" },
            { id: "OVB", name: "Novossibirsk", lat: 55.0126, lon: 82.6507, country: "Russie" },
            { id: "VVO", name: "Vladivostok", lat: 43.3990, lon: 132.1480, country: "Russie" },
            { id: "KGD", name: "Kaliningrad", lat: 54.8900, lon: 20.5926, country: "Russie" },
            { id: "AER", name: "Sotchi Intl", lat: 43.4499, lon: 39.9566, country: "Russie" },
            { id: "ALA", name: "Almaty Intl", lat: 43.3520, lon: 77.0405, country: "Kazakhstan" },
            { id: "TAS", name: "Tachkent Intl", lat: 41.2579, lon: 69.2812, country: "Ouzb√©kistan" },
            { id: "GYD", name: "Bakou", lat: 40.4675, lon: 50.0467, country: "Azerba√Ødjan" },

            // --- OC√âANIE ---
            { id: "SYD", name: "Sydney Kingsford Smith", lat: -33.9399, lon: 151.1753, country: "Australie" },
            { id: "AKL", name: "Auckland Airport", lat: -37.0082, lon: 174.7850, country: "Nouvelle-Z√©lande" },
            { id: "MEL", name: "Melbourne Airport", lat: -37.6690, lon: 144.8410, country: "Australie" },
            { id: "BNE", name: "Brisbane Airport", lat: -27.3842, lon: 153.1175, country: "Australie" },
            { id: "PPT", name: "Tahiti Faa'a", lat: -17.5569, lon: -149.6060, country: "Polyn√©sie Fran√ßaise" },
            { id: "NOU", name: "Noum√©a La Tontouta", lat: -22.0145, lon: 166.2130, isIsland: true, country: "Nouvelle-Cal√©donie" },
            { id: "OOL", name: "Gold Coast", lat: -28.1644, lon: 153.5047, country: "Australie" },
            { id: "PER", name: "Perth Airport", lat: -31.9403, lon: 115.9670, country: "Australie" },
            { id: "CHC", name: "Christchurch Intl", lat: -43.4894, lon: 172.5322, country: "Nouvelle-Z√©lande" }, 
            { id: "WLG", name: "Wellington Intl", lat: -41.3272, lon: 174.8076, country: "Nouvelle-Z√©lande" },
            { id: "SEZ", name: "Seychelles Intl", lat: -4.6744, lon: 55.5217, isIsland: true, country: "Seychelles" },
            { id: "NAN", name: "Fidji (Nadi Intl)", lat: -17.7554, lon: 177.4412, isIsland: true, country: "Fidji" },
            { id: "BOB", name: "Bora Bora", lat: -16.4444, lon: -151.7514, isIsland: true, country: "Polyn√©sie Fran√ßaise" }, 
            { id: "GUM", name: "Guam", lat: 13.4839, lon: 144.7972, isIsland: true, country: "Guam" }
        ];

        let map, planeMarker, flightLine;
        let timeLeft, totalTime, timerInterval;
        let startCoords, endCoords;

        // Trie les a√©roports par ordre alphab√©tique
        airports.sort((a, b) => a.name.localeCompare(b.name));
        
        const originSelect = document.getElementById('origin');
        const destSelect = document.getElementById('destination');

        airports.forEach(ap => {
            originSelect.innerHTML += `<option value="${ap.id}">${ap.name}</option>`;
            destSelect.innerHTML += `<option value="${ap.id}">${ap.name}</option>`;
        });

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function getFlightDuration(lat1, lon1, lat2, lon2) {
            const dist = calculateDistance(lat1, lon1, lat2, lon2);
            const rawFlightTime = (dist / 800) * 60;

            // On ajoute 15% de temps pour les manoeuvres (minimum 2 minutes pour la s√©curit√©)
            const bufferProportionnel = Math.max(2, rawFlightTime * 0.15);
            
            return Math.round(rawFlightTime + bufferProportionnel);
        }

        function updateDurationDisplay() {
            const a = airports.find(x => x.id === originSelect.value);
            const b = airports.find(x => x.id === destSelect.value);
            if(a.id === b.id) {
                document.getElementById('estimated-time').textContent = "Choisissez une destination diff√©rente";
                return;
            }
            const totalMinutes = getFlightDuration(a.lat, a.lon, b.lat, b.lon);

            // On convertit les minutes en secondes pour notre fonction de formatage
            const timeString = formatTimeHHMMSS(totalMinutes * 60);
            document.getElementById('estimated-time').textContent = `Dur√©e estim√©e : ${timeString}`;
        }

        [originSelect, destSelect].forEach(s => s.addEventListener('change', updateDurationDisplay));
        updateDurationDisplay();

        function proposeRandomFlight() {
            const targetHours = parseInt(document.getElementById('pick-hours').value) || 0;
            const targetMins = parseInt(document.getElementById('pick-mins').value) || 0;
            const targetTotalMins = (targetHours * 60) + targetMins;

            if (targetTotalMins <= 0) return alert("Choisissez une dur√©e sup√©rieure √† 0 !");

            let validFlights = [];

            // D√©finition de la marge d'erreur : 20% du temps demand√© (minimum 2 min de battement)
            const margin = Math.max(2, targetTotalMins * 0.2);

            // On parcourt tous les a√©roports de d√©part possibles
            for (let i = 0; i < airports.length; i++) {
                // On parcourt tous les a√©roports d'arriv√©e possibles
                for (let j = 0; j < airports.length; j++) {
                    if (i === j) continue; // Pas de vol vers la m√™me ville

                    const startApt = airports[i];
                    const endApt = airports[j];
                    // On calcule la dur√©e de ce trajet
                    const flightMins = getFlightDuration(startApt.lat, startApt.lon, endApt.lat, endApt.lon);

                    // V√©rification avec la marge dynamique
                    if (Math.abs(flightMins - targetTotalMins) <= margin) {
                       validFlights.push({ start: startApt.id, end: endApt.id, diff: Math.abs(flightMins - targetTotalMins) });
                    }
                }
            }

            if (validFlights.length > 0) {
                // Optionnel : on trie pour prendre les 10 vols les plus proches du temps demand√©
                // cela √©vite de proposer un vol de 8 min quand on demande 5 min s'il existe un vol de 5 min.
                validFlights.sort((a, b) => a.diff - b.diff);
                const topChoices = validFlights.slice(0, 15);
                // --- LE POINT AL√âATOIRE ---
                // On choisit un trajet au hasard parmi ceux qui correspondent
                const randomChoice = topChoices[Math.floor(Math.random() * topChoices.length)];
        
                // On met √† jour les s√©lecteurs de la page d'accueil
                document.getElementById('origin').value = randomChoice.start;
                document.getElementById('destination').value = randomChoice.end;
        
                // On met √† jour l'affichage du temps
                updateDurationDisplay();
                
                // Petit effet visuel pour montrer que √ßa a chang√©
                document.getElementById('selection-screen').style.boxShadow = "0 0 20px var(--accent)";
                setTimeout(() => {
                    document.getElementById('selection-screen').style.boxShadow = "0 8px 32px rgba(0,0,0,0.5)";
                }, 500);

            }else {
                alert("Aucun vol trouv√© pour cette dur√©e. Essayez un autre temps !");
            }
        }

        let selectMap; // Variable pour la carte de s√©lection
        let selectMarkers = []; // Pour stocker les marqueurs
        let flightPathLine = null; // La ligne du trajet
        let tempOrigin = null;
        let tempDest = null;

        // Ouvre la modale et initialise la carte si n√©cessaire
        function openSelectionMap() {
            document.getElementById('map-modal').classList.remove('hidden');
    
            // Si la carte n'existe pas encore, on la cr√©e
            if (!selectMap) {
                selectMap = L.map('selection-map').setView([20, 0], 2);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                    attribution: '¬© OpenStreetMap, ¬© CartoDB'
                }).addTo(selectMap);
        
                // On ajoute les a√©roports
                displayAirportsOnMap();
            }
    
            // Important : Leaflet a besoin de savoir que la taille a chang√© car elle √©tait cach√©e
            setTimeout(() => { selectMap.invalidateSize(); }, 100);
    
            resetSelectionMap();
        }

        function closeSelectionMap() {
            document.getElementById('map-modal').classList.add('hidden');
        }

        // Affiche tous les points bleus
        function displayAirportsOnMap() {
            console.log("D√©marrage de l'affichage des a√©roports...");
            // 1. Nettoyage s√©curis√©
            if (selectMarkers) {
                selectMarkers.forEach(m => selectMap.removeLayer(m));
                selectMarkers = [];
            }

            // 2. R√©cup√©ration de l'historique
            const logData = localStorage.getItem('focusFlightLog');
            const logbook = logData ? JSON.parse(logData) : [];
            console.log("Vols trouv√©s dans l'historique:", logbook.length);
    
            // 3. Cr√©er un Set des IDs visit√©s (plus rapide pour la recherche)
            // On regarde √† la fois dans 'from' et 'to' au cas o√π l'ID y est stock√© directement
            const visitedIDs = new Set();
            logbook.forEach(f => {
                if (f.key && typeof f.key === 'string') {
                    const ids = f.key.split('-'); // On s√©pare la cl√© "BRU-CAG"
                    visitedIDs.add(ids[0]);
                    visitedIDs.add(ids[1]);
                    console.log("s√©paration du string f.key en 2 ")
                } else {
                    console.log("N'est pas rentr√© dans le 'if' !!");
                }
            });

            airports.forEach(airport => {
                
                // On s'assure que les coordonn√©es sont bien des nombres
                const lat = parseFloat(airport.lat);
                const lon = parseFloat(airport.lon);
                // D√©finir les couleurs en fonction de la visite
                const isVisited = visitedIDs.has(airport.id);

                if (!isNaN(lat) && !isNaN(lon)) {
                    const marker = L.circleMarker([lat, lon], {
                        className: isVisited ? 'marker-visited' : 'marker-normal'
                    }).addTo(selectMap);
                    marker.setRadius(isVisited ? 4 : 7);

                    // Ajout d'une propri√©t√© custom pour retrouver l'ID
                    marker.airportId = airport.id;
                    marker.airportName = airport.name;

                    // Interaction au clic
                    marker.on('click', () => handleMarkerClick(marker, airport));
                    selectMarkers.push(marker);
                }
            });
        }

        // ---**  G√®re la logique des 2 clics (D√©part -> Arriv√©e)  **---
        function handleMarkerClick(marker, data) {
            // Cas 1: S√©lection du D√©part
            if (!tempOrigin) {
                tempOrigin = data;
        
                // Changement visuel : Vert pour d√©part
                setDeparture(marker);
                marker.bindPopup(`üõ´ D√©part : ${data.name}`).openPopup();
        
            // Cas 2: S√©lection de l'Arriv√©e (si diff√©rent du d√©part)
            } else if (!tempDest && data.id !== tempOrigin.id) {
                tempDest = data;
        
                // Changement visuel : Rouge pour arriv√©e
                setArrival(marker);
        
                // Calcul du temps
                const dist = calculateDistance(tempOrigin.lat, tempOrigin.lon, tempDest.lat, tempDest.lon);
                const time = getFlightDuration(tempOrigin.lat, tempOrigin.lon, tempDest.lat, tempDest.lon);

                // Affiche la ligne
                if (flightPathLine) selectMap.removeLayer(flightPathLine);
                    flightPathLine = L.polyline([[tempOrigin.lat, tempOrigin.lon], [tempDest.lat, tempDest.lon]], {
                    color: 'var(--accent)', weight: 3, dashArray: '10, 10'
                }).addTo(selectMap);
            

                // Popup finale avec le temps
                marker.bindPopup(`
                    <b>üõ¨ Arriv√©e : ${data.name}</b><br>
                    Distance : ${Math.round(dist)} km<br>
                    ‚è±Ô∏è Dur√©e de focus : <b>${time} min</b>
                `).openPopup();

                // Affiche le bouton de confirmation
                document.getElementById('btn-confirm-route').classList.remove('hidden');

            // Cas 3: Reset si on clique ailleurs ou pour recommencer
            } else {
                resetSelectionMap();
                handleMarkerClick(marker, data); // On relance le clic comme si c'√©tait le premier
            }
        }

        function setDeparture(marker) {
            // On retire les autres classes possibles et on met la verte
            L.DomUtil.removeClass(marker._path, 'marker-normal');
            L.DomUtil.removeClass(marker._path, 'marker-visited');
            L.DomUtil.addClass(marker._path, 'marker-departure');
    
            marker.setRadius(10); // On force la taille agrandie
        }

        // Pour l'arriv√©e
        function setArrival(marker) {
            L.DomUtil.removeClass(marker._path, 'marker-normal');
            L.DomUtil.removeClass(marker._path, 'marker-visited');
            L.DomUtil.addClass(marker._path, 'marker-arrival');
    
            marker.setRadius(10); // On force la taille agrandie
        }

        // Reset visuel
        function resetSelectionMap() {
            tempOrigin = null;
            tempDest = null;
            if (flightPathLine) selectMap.removeLayer(flightPathLine);
            document.getElementById('btn-confirm-route').classList.add('hidden');
            selectMap.closePopup();
            
            // On r√©cup√®re les IDs visit√©s pour savoir quel style remettre
            const logData = localStorage.getItem('focusFlightLog');
            const logbook = logData ? JSON.parse(logData) : [];
            const visitedIDs = new Set();
            logbook.forEach(f => {
                if (f.key) f.key.split('-').forEach(id => visitedIDs.add(id));
            });
            // Remet tous les marqueurs √† z√©ro
            selectMarkers.forEach(m => {
                L.DomUtil.removeClass(m._path, 'marker-departure');
                L.DomUtil.removeClass(m._path, 'marker-arrival');
                L.DomUtil.removeClass(m._path, 'marker-normal');
                L.DomUtil.removeClass(m._path, 'marker-visited');

                const isVisited = visitedIDs.has(m.airportId);
                // 3. On applique la bonne classe et le bon rayon
                const targetClass = isVisited ? 'marker-visited' : 'marker-normal';
                L.DomUtil.addClass(m._path, targetClass);
            
                // Forcer le rayon
                m.setRadius(isVisited ? 4 : 7);
            });
        }

        // Valide et met √† jour l'√©cran principal
        function confirmRouteSelection() {
            console.log("Validation du trajet..."); // Pour v√©rifier dans la console (F12)
            if (tempOrigin && tempDest) {
                try {
                    // 1. Mise √† jour des s√©lecteurs
                    document.getElementById('origin').value = tempOrigin.id;
                    document.getElementById('destination').value = tempDest.id;

                    // 2. Mise √† jour de l'affichage du temps
                    updateDurationDisplay();

                } catch (e) {
                    console.error("Erreur lors de la mise √† jour des champs :", e);
                }
        
                closeSelectionMap();
            } else {
                alert("Veuillez s√©lectionner un d√©part (vert) et une arriv√©e (rouge).");
            }
        }
        
        function takeOff() {
            const a = airports.find(x => x.id === originSelect.value);
            const b = airports.find(x => x.id === destSelect.value);
            if (a.id === b.id) return;

            startCoords = [a.lat, a.lon];
            endCoords = [b.lat, b.lon];
            
            const totalMinutes = getFlightDuration(a.lat, a.lon, b.lat, b.lon);
            totalTime = totalMinutes * 60;
            timeLeft = totalTime;
    
            // Date.now() donne l'heure actuelle en millisecondes. 
            // On y ajoute la dur√©e du vol convertie en millisecondes.
            flightEndTime = Date.now() + (totalTime * 1000);

            // --- GESTION DU MODE STRICT ---
            const isStrictMode = document.getElementById('strict-mode').checked;
            if (isStrictMode) {
                enableFocusPrison(); // On lance la "prison"
                // On cache les boutons de r√©glages et de th√®me
                document.getElementById('menu-toggle').classList.add('hidden');
                document.getElementById('theme-switcher').classList.add('hidden');
                // On cache le bouton de mode strict d√®s qu'on d√©colle si le mode strict est actif
                document.getElementById('strict-toggle-btn').classList.add('hidden');
            }

            // 1. Afficher d'abord l'√©cran de vol (tr√®s important pour que les √©l√©ments soient visibles)
            document.getElementById('selection-screen').classList.add('hidden');
            document.getElementById('btn-go').classList.add('hidden');
            document.getElementById('flight-screen').style.display = 'flex';
            
            // 2. On change le texte de l'info-vol sans √©craser le HTML
            // On s'assure que l'√©l√©ment existe avant d'√©crire dedans
            const destNameElement = document.getElementById('dest-name');
            if (destNameElement) {
                destNameElement.textContent = b.name.toUpperCase();
            }

            // 3. R√©initialiser le reste de l'UI
            document.getElementById('progress-bar').style.width = "0%";
            document.getElementById('timerDisplay').textContent = formatTimeHHMMSS(totalTime);

            initMap();
            startTimer();
            updateAmbient();
        }

        function initMap() {
            // On cr√©e la carte UNE SEULE FOIS avec toutes les options (PC + Mobile)
            map = L.map('map', { 
                zoomControl: false,
                dragging: !L.Browser.mobile, // Optimisation mobile
                tap: false 
            }).setView(startCoords, 5);

            // Quand l'utilisateur commence √† bouger la carte
            map.on('movestart', () => {
                isAutoCenterEnabled = false; // On coupe le centrage auto
                clearTimeout(autoCenterTimeout); // On annule le timer de r√©activation s'il tournait
            });

            // Quand l'utilisateur arr√™te de bouger la carte
            map.on('moveend', () => {
                // On attend 3 secondes avant de r√©activer le centrage automatique
                autoCenterTimeout = setTimeout(() => {
                    isAutoCenterEnabled = true;
                }, 1500); // Tu peux changer 1500 (1.5s) par le d√©lai de ton choix
            });

            // On applique le style (Sombre/Clair)
            updateMapStyle();
    
            // On r√©cup√®re la couleur pour la ligne
            const color = getComputedStyle(document.documentElement).getPropertyValue('--line-color').trim();
    
            // On dessine la ligne de trajectoire
            flightLine = L.polyline([startCoords, endCoords], {
                color: color, 
                weight: 2, 
                dashArray: '10, 10'
            }).addTo(map);
    
            // On ajoute l'ic√¥ne de l'avion
            const planeIcon = L.divIcon({ html: '‚úàÔ∏è', className: 'plane-icon', iconAnchor: [12, 12] });
            planeMarker = L.marker(startCoords, {icon: planeIcon}).addTo(map);
        }

        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);

            timerInterval = setInterval(() => {
                // Calcul du temps restant r√©el : (Heure de fin - Heure actuelle) / 1000
                const now = Date.now();
                const difference = Math.floor((flightEndTime - now) / 1000);

                if (difference > 0) {
                    timeLeft = difference;
                    updateUI();
                } else {
                    // Le vol est termin√©
                    timeLeft = 0;
                    updateUI();
                    clearInterval(timerInterval);
                    timerInterval = null;
                    ambientSound.pause(); // On arr√™te le moteur √† l'arriv√©e
                    disableFocusPrison();
                    
                    // 2. S√©quence de Dings
                    const playDing = () => {
                        dingSound.currentTime = 0;
                        dingSound.play().catch(e => console.log("Erreur son"));
                    };

                    // On vide le tableau avant de commencer
                    dingTimers = [];
                    // On stocke les timers pour pouvoir les annuler si besoin
                    playDing(); // Imm√©diat
                    dingTimers.push(setTimeout(playDing, 5000)); // 2e ding apr√®s 5s
                    dingTimers.push(setTimeout(playDing, 10000)); // 2e ding apr√®s 10s

                    // 3. Affichage de la fen√™tre personnalis√©e au lieu de l'alert()
                    document.getElementById('arrival-modal').classList.remove('hidden');
                    document.getElementById('modal-overlay').classList.remove('hidden');
                    
                    // 4. Mise √† jour de l'interface (force l'affighage √† 00:00, affiche le bouton de retour, affiche un petit message de f√©licitations)
                    document.getElementById('timerDisplay').textContent = "00:00";
                    document.getElementById('btn-home').classList.remove('hidden');
                    document.getElementById('menu-toggle').classList.remove('hidden');
                    document.getElementById('theme-switcher').classList.remove('hidden');
                    document.getElementById('flight-info').textContent = "BIENVENUE √Ä DESTINATION !";

                    // On r√©cup√®re les infos du vol actuel
                    const depart = airports.find(x => x.id === originSelect.value);
                    const arrivee = airports.find(x => x.id === destSelect.value);
                    const temps = getFlightDuration(depart.lat, depart.lon, arrivee.lat, arrivee.lon);

                    // On appelle la fonction de sauvegarde
                    saveFlightToLogbook(depart, arrivee, temps);
                }
            }, 1000);
        }

        function saveFlightToLogbook(startObj, endObj, duration) {
            // 1. R√©cup√©rer le carnet actuel (ou en cr√©er un vide s'il n'existe pas)
            let logbook = JSON.parse(localStorage.getItem('focusFlightLog')) || [];

            // On cr√©e une cl√© unique pour le trajet ; On utilise l'ID (ex: BRU) pour la cl√© unique
            const flightKey = `${startObj.id}-${endObj.id}`;
            // On cherche si ce trajet a d√©j√† √©t√© fait
            const existingFlight = logbook.find(f => f.key === flightKey);

            if (existingFlight) {
                existingFlight.count += 1;
                existingFlight.totalTime += duration;
                existingFlight.lastDate = new Date().toLocaleDateString();
            } else {
                logbook.push({
                    key: flightKey,
                    from: startObj.name, // On stocke le nom
                    to: endObj.name,
                    count: 1,
                    totalTime: duration,
                    lastDate: new Date().toLocaleDateString()
                });
            }

            localStorage.setItem('focusFlightLog', JSON.stringify(logbook));
            console.log("Vol enregistr√© dans le logbook !");
        }

        function openHistoryModal() {
            const container = document.getElementById('history-table-body');
            const logbook = JSON.parse(localStorage.getItem('focusFlightLog')) || [];
            
            // CALCUL DU TEMPS TOTAL
            const totalMinutes = logbook.reduce((acc, flight) => acc + (flight.totalTime || 0), 0);
    
            // AFFICHAGE DU TEMPS TOTAL (Format√© en heures si n√©cessaire)
            const totalDisplay = document.getElementById('total-focus-time');
            if (totalMinutes >= 60) {
                const hours = Math.floor(totalMinutes / 60);
                const mins = totalMinutes % 60;
                totalDisplay.innerText = `Total : ${hours}h ${mins}m`;
            } else {
                totalDisplay.innerText = `Total : ${totalMinutes} min`;
            }

            document.getElementById('history-modal').style.display = 'flex';
    
            if (logbook.length === 0) {
                container.innerHTML = `<p style="opacity: 0.6; text-align: center;">Aucun vol dans les archives.</p>`;
                return;
            }

            // On g√©n√®re le HTML pour chaque vol
            let html = '';
            logbook.forEach(f => {
                // On extrait le nom depuis l'objet stock√©. 
                // Si f.from est un objet, on prend .name, sinon on affiche f.from par s√©curit√©.
                const startName = typeof f.from === 'object' ? f.from.name : f.from;
                const endName = typeof f.to === 'object' ? f.to.name : f.to;

                html += `<tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                        <td style="padding: 15px 0; width: 60%;">
                            <span style="font-weight: bold; color: var(--accent);">${startName}</span> 
                            <span style="opacity: 0.5;">‚ûî</span> 
                            <span style="font-weight: bold; color: var(--accent);">${endName}</span>
                        </td>
                        <td style="text-align: center; width: 15%; font-weight: 500;">${f.count}</td>
                        <td style="text-align: right; width: 25%; font-weight: 500;">${f.totalTime} min</td>
                    </tr>`;
            });
    
            html += '</table>';
            container.innerHTML = html;
        }

        function closeHistoryModal() {
            document.getElementById('history-modal').style.display = 'none';
            // Optionnel : Fermer la modale si on clique en dehors de la bo√Æte
            window.onclick = function(event) {
            const modal = document.getElementById('badge-modal');
            if (event.target == modal)
                closeHistoryModal();
            }
        }

        function clearHistory() {
            if (confirm("Voulez-vous vraiment effacer tout votre historique ? \n Cela r√©initialisera aussi vos succ√®s ")) {
                localStorage.removeItem('focusFlightLog');
                openHistoryModal(); // Rafra√Æchit l'affichage
            }
        }

        function openBadgeModal() {
            // On affiche la modale avec flex pour le centrage
            document.getElementById('badge-modal').style.display = 'flex';
    
            updateBadges(); // On calcule les succ√®s
        }

        function closeBadgeModal() {
            document.getElementById('badge-modal').style.display = 'none';
        }

        function updateBadges() {
            const logbook = JSON.parse(localStorage.getItem('focusFlightLog')) || [];
    
            // Stats de base
            const totalHours = logbook.reduce((s, f) => s + (parseInt(f.totalTime) || 0), 0) / 60;
            const airportsSet = new Set();
            const islandsSet = new Set();
            const countriesSet = new Set();
            let islandStreak = 0;
            let maxIslandStreak = 0;

            logbook.forEach(f => {
                if (f.key) {
                    // On s√©pare "BRU-JFK" en ["BRU", "JFK"]
                    const ids = f.key.split('-'); 
                    const fromId = ids[0];
                    const toId = ids[1];

                    // On ajoute les deux a√©roports au Set (le Set g√®re les doublons automatiquement)
                    airportsSet.add(fromId);
                    airportsSet.add(toId);

                    // V√©rification si l'a√©roport de destination est une √Æle
                    const arrivalAirport = airports.find(a => a.id === toId);
                    if (arrivalAirport) {
                        // 2. Si c'est une √Æle, on l'ajoute au compteur d'√Æles
                        if (arrivalAirport.isIsland) {
                            islandsSet.add(toId);
                
                            // --- LOGIQUE DU SUCC√àS DIFFICILE (S√©rie d'√Æles) ---
                            islandStreak++; // On ajoute 1 √† la s√©rie actuelle
                            if (islandStreak > maxIslandStreak) {
                                maxIslandStreak = islandStreak; // On retient le record
                            }
                        } else {
                            // Si on atterrit sur le continent, la s√©rie d'√Æles retombe √† z√©ro !
                            islandStreak = 0;
                        }
                        // 3. On ajoute le pays au compteur (Succ√®s Citoyen du Monde)
                        // Note : cela ne marchera que si tu as ajout√© "country: 'France'" dans ta liste d'a√©roports
                        if (arrivalAirport.country) {
                            countriesSet.add(arrivalAirport.country);
                        }
                    }
                }
            });

            const definitions = [
                { id: 'endurance', title: "Endurance", icon: "‚è±Ô∏è", stat: totalHours, color: "#4caf50", levels: [{t:1, n:"Novice"}, {t:10, n:"Commandant"}, {t:50, n:"Photon"}] },
                { id: 'globetrotter', title: "Globe-Trotter", icon: "üåç", stat: airportsSet.size, color: "#4caf50", levels: [{t:5, n:"Touriste"}, {t:15, n:"Voyageur"}, {t:30, n:"PDG Jet"}] },
                { id: 'island', title: "Island Lover", icon: "üèùÔ∏è", stat: islandsSet.size, color: "#4caf50", levels: [{t:2, n:"Saut de puce"}, {t:5, n:"Robinson"}, {t:10, n:"Roi"}] },
                { id: 'assiduite', title: "Assiduit√©", icon: "üî•", stat: logbook.length, color: "#4caf50", levels: [{t:5, n:"Copilote"}, {t:20, n:"V√©t√©ran"}, {t:100, n:"L√©gende"}] },
                { id : 'country_hopper', title: "Citoyen du Monde", icon: "üõÇ", stat: countriesSet.size, color: "#4caf50", levels: [{t: 3, n: "Expatri√©"}, {t: 10, n: "Diplomate"}, {t: 25, n: "Ambassadeur UN"}] },
                { id: 'island_streak', title: "L'Appel du Large", icon: "üåä", stat: maxIslandStreak, color: "#4caf50", levels: [{t: 3, n: "Vrai Marin"}, {t: 6, n: "L√©gende des Mers"}, {t: 12, n: "Pos√©idon"}] }
            ];

            let html = "";
            definitions.forEach(badge => {
                // Trouver le niveau actuel et le prochain
                const currentLvl = [...badge.levels].reverse().find(l => badge.stat >= l.t) || {n: "D√©butant", t: 0};
                const nextLvl = badge.levels.find(l => badge.stat < l.t);
        
                // Calcul du pourcentage de progression
                let percent = 0;
                let infoText = "";

                if (nextLvl) {
                    percent = (badge.stat / nextLvl.t) * 100;
                    infoText = `${Math.floor(badge.stat)} / ${nextLvl.t} pour ${nextLvl.n}`;
                } else {
                    percent = 100; // Maximum atteint
                    infoText = "Niveau Maximum atteint !";
                }

                html += `
                <div class="badge-card">
                    <div style="font-size: 1.5em;">${badge.icon}</div>
                    <h4>${badge.title}</h4>
                    <div class="current-rank">${currentLvl.n}</div>
                    <div class="badge-progress-container">
                        <div class="badge-progress-bar" style="width: ${percent}%; background: ${badge.color}; box-shadow: 0 0 12px ${badge.color}CC;"></div>
                    </div>
                    <div class="next-step">${infoText}</div>
                </div>`;
            });

            document.getElementById('badge-list-container').innerHTML = html;
        }

        function showAllBadgesHelp() {

            // Cette partie suppose que 'definitions' est accessible. 
            // Si ce n'est pas le cas, tu peux le copier ici ou le d√©clarer en dehors de updateBadges
            const helpContent = `
                <ul style="list-style: none; padding: 0;">
                    <li style="margin-bottom: 15px;"><strong>‚è±Ô∏è Endurance :</strong> Le ciel ne conna√Æt pas de fronti√®res pour ceux qui ne comptent pas leurs heures. Ce troph√©e r√©compense votre temps pass√© aux commandes. (calcul√© en heures).</li>
                    <li style="margin-bottom: 15px;"><strong>üåç Globe-Trotter :</strong> Chaque piste d'atterrissage est une nouvelle histoire. Cumulez les escales √† travers le monde pour devenir une ic√¥ne de l'aviation. Nombre total d'a√©roports uniques visit√©s. (d√©parts et arriv√©es).</li>
                    <li style="margin-bottom: 15px;"><strong>üèùÔ∏è Island Lover :</strong> Il y a quelque chose de magique √† poser ses roues sur un bout de terre entour√© d'eau. Visitez des destinations insulaires uniques. Nombre total d'√Æles diff√©rentes o√π vous avez atterri.</li>
                    <li style="margin-bottom: 15px;"><strong>üî• Assiduit√© :</strong> La r√©gularit√© est la marque des plus grands pilotes. Encha√Ænez les missions pour graver votre nom dans la l√©gende de Focus Airlines. Cumul de tous vos vols enregistr√©s dans Focus Airlines.</li>
                    <li style="margin-bottom: 15px;"><strong>üõÇ Citoyen du Monde :</strong> Franchir les fronti√®res, c'est ouvrir son esprit. Collectionnez les tampons sur votre passeport virtuel en visitant diff√©rents pays. Nombre de pays diff√©rents d√©couverts lors de vos escales.</li>
                    <li style="margin-bottom: 15px;"><strong>üåä L'Appel du Large :</strong> Un d√©fi p√©rilleux : encha√Ænez les vols d'√Æle en √Æle sans jamais toucher le continent. √âcoutez le chant des sir√®nes, mais ne perdez pas le cap ! Votre record de vols successifs entre deux √Æles (se brise si vous atterrissez sur le continent).</li>
                </ul>
            `;

            // Utilisation de l'overlay personnalis√© que nous avons cr√©√© juste avant
            const overlay = document.getElementById('info-overlay');
            if (overlay) {
                document.getElementById('info-title').innerText = "√Ä propos des succ√®s";
                document.getElementById('info-text').innerHTML = helpContent;
                document.getElementById('info-text').style.textAlign = "left"; // On aligne le texte √† gauche pour la liste
                overlay.style.display = 'flex';
            } else {
                alert(helpContent);
            }
        }

        function updateUI() {
            // PLUS BESOIN de calculer les mins et secs ici, on utilise notre fonction formatTime!
            document.getElementById('timerDisplay').textContent = formatTimeHHMMSS(timeLeft);
    
            const progress = (totalTime - timeLeft) / totalTime;
            document.getElementById('progress-bar').style.width = (progress * 100) + "%";

            // Calcul position actuelle
            const currentLat = startCoords[0] + (endCoords[0] - startCoords[0]) * progress;
            const currentLon = startCoords[1] + (endCoords[1] - startCoords[1]) * progress;
            const newPos = [currentLat, currentLon];

            // 1. L'avion avance TOUJOURS
            planeMarker.setLatLng(newPos);
    
            // 2. La carte ne se centre QUE SI l'utilisateur ne la touche pas
            if (isAutoCenterEnabled) {
                // panTo avec animation pour plus de fluidit√©
                map.panTo(newPos, { animate: true, duration: 0.5 });
            }
        }

        function resetToHome() {
            // Arr√™ter proprement le timer s'il tourne encore
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            // R√©initialisation des variables de temps
            timeLeft = 0;
            totalTime = 0;
            flightEndTime = 0;
            // 1. On cache l'√©cran de vol et le bouton de retour
            document.getElementById('flight-screen').style.display = 'none';
            document.getElementById('btn-home').classList.add('hidden');

            document.getElementById('arrival-modal').classList.add('hidden');
            document.getElementById('modal-overlay').classList.add('hidden');

            // 2. On r√©affiche l'accueil et le bouton d√©collage
            document.getElementById('selection-screen').classList.remove('hidden');
            document.getElementById('btn-go').classList.remove('hidden');

            // 3. On d√©truit la carte pour pouvoir la recr√©er proprement au prochain vol
            // (C'est comme lib√©rer la m√©moire en C avec free() !)
            if (map) {
                map.off(); // Supprime tous les √©couteurs d'√©v√©nements
                map.remove();
                map = null;
            }
        }

        // Cette fonction ferme la fen√™tre d'arriv√©e √† destination quand on clique sur OK
        function closeArrivalModal() {
            // 1. On annule les dings qui n'ont pas encore sonn√©
            dingTimers.forEach(timer => clearTimeout(timer));
            dingTimers = []; // On vide le tableau

            // 2. On coupe le son imm√©diatement s'il est en train de jouer
            dingSound.pause();
            dingSound.currentTime = 0;

            // 3. On cache la fen√™tre
            document.getElementById('arrival-modal').classList.add('hidden');
            document.getElementById('modal-overlay').classList.add('hidden');
        }

        // Cette fonction "d√©bloque" l'audio sur les navigateurs capricieux
        document.body.addEventListener('click', function() {
            if (ambientSound.paused && document.getElementById('ambient-toggle').checked) {
                ambientSound.play().catch(() => {}); 
            }
        }, { once: true }); // Ne s'ex√©cute qu'une seule fois

        window.onbeforeunload = function() {
            // Si un vol est en cours (timerInterval existe), on demande confirmation
            if (timerInterval) {
                return "Votre vol est en cours ! Si vous quittez, votre session de focus sera perdue.";
            }
        };

        async function enableFocusPrison() {
            // 1. Passage en Plein √âcran
            if (!document.fullscreenElement) {
                try {
                    await document.documentElement.requestFullscreen();

                    // 2. Verrouillage de l'Orientation (Paysage pour la carte)
                    if (screen.orientation && screen.orientation.lock) {
                        await screen.orientation.lock('landscape').catch(e => {
                            console.log("Le verrouillage d'orientation a √©t√© refus√©.");
                        });
                    }
                } catch (err) {
                    console.log("Erreur lors de l'activation du mode strict : ", err);
                }
            }

            // 3. Blocage du bouton "Retour" du t√©l√©phone
            window.history.pushState(null, null, window.location.href);
            window.onpopstate = function() {
                // Si l'utilisateur fait "retour", on le remet imm√©diatement sur la page
                window.history.pushState(null, null, window.location.href);
                alert("üîí VOL EN COURS : Le mode strict emp√™che le retour en arri√®re.");
            };
        }

        // Fonction pour lib√©rer l'utilisateur √† l'arriv√©e
        function disableFocusPrison() {
            if (document.fullscreenElement) {
                document.exitFullscreen();
            }
            if (screen.orientation && screen.orientation.unlock) {
                screen.orientation.unlock();
            }
            window.onpopstate = null; // On lib√®re le bouton retour
        }

    </script>
    <script>
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js');
    }
    </script>
</body>
</html>